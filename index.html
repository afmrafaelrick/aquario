<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#003f5c">
<meta charset="UTF-8">
<title>Aqu√°rio ‚Äì Manuten√ß√£o</title>

<style>
* {
  box-sizing: border-box;
}


body {
  background:#002b3d;
  color:white;
  font-family:Arial, sans-serif;
  padding:0px;
  margin: 0;
  overflow-x: hidden;
  width: 100%;
  max-width: 100%;
}

h2 {
  margin-bottom:10px;
}
#titulo {
  font-size: 2rem;   /* ajuste fino aqui */
  font-weight: 600;
  margin-bottom: 12px;
  text-align: center;
  letter-spacing: 0.5px;
}
  
@media (max-width: 600px) {
  #titulo {
    font-size: 1.8rem;
  }
}

  
button {
  background: linear-gradient(145deg, #1fa2d6, #137aa6);
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  color: white;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.35);
}

button:active {
  transform: translateY(0);
  box-shadow: 0 3px 8px rgba(0,0,0,0.25);
}

button.secundario {
  background: linear-gradient(145deg, #5f6f7a, #3e4c55);
  font-weight: normal;
}


@keyframes fadeUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}


@keyframes pulse {
  0%   { box-shadow: 0 0 0 rgba(241,196,15,0.0); }
  50%  { box-shadow: 0 0 12px rgba(241,196,15,0.6); }
  100% { box-shadow: 0 0 0 rgba(241,196,15,0.0); }
}

.card.alerta {
  animation: pulse 2.5s infinite;
}

@keyframes pulseRed {
  0%   { box-shadow: 0 0 0 rgba(255,107,107,0.0); }
  50%  { box-shadow: 0 0 14px rgba(255,107,107,0.6); }
  100% { box-shadow: 0 0 0 rgba(255,107,107,0.0); }
}

.hidden {
  display: none;
}

.card.critico {
  animation: pulseRed 2s infinite;
}


.card {
  background: linear-gradient(145deg, #014f6e, #00384f);
  border-radius: 18px;
  padding: 18px;
  color: #fff;
  cursor: pointer;
  box-shadow: 0 6px 14px rgba(0,0,0,0.35);
  transition: transform 0.2s, box-shadow 0.2s;
  animation: fadeUp 0.35s ease both;
  position: relative; /* permite sobreposi√ß√£o */
  width: 100%;
  max-width: 100%;
  overflow: hidden;1
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.45);
}

/* Cores de status */
.card.ok       { border-left: 6px solid #3bd671; }
.card.alerta   { border-left: 6px solid #f1c40f; }
.card.critico  { border-left: 6px solid #ff6b6b; }
.card.neutro   { border-left: 6px solid #7f8c8d; }




.card-header {
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-status {

  top: 8px;
  right: 10px;
  font-size: 28px;
  opacity: 0.9;
}


.card-icon {
  font-size: 48px;
  max-width: 100%;
  line-height: 1;
}

.card-title {
  font-size: 28px;
  font-weight: bold;
  line-height: 1.2;
  word-break: break-word;
  flex: 1;              /* ‚Üê ocupa o espa√ßo dispon√≠vel */
}


.card-body {
  font-size: 28px;
  opacity: 0.95;
}

.card-body .ideal {
  margin-top: 4px;
  font-size: 26px;
  opacity: 0.85;
}


.card-days {
  font-size: 52px;
  font-weight: bold;
  margin-top: 8px;
}

.card-days span {
  font-size: 26px;
  font-weight: normal;
  opacity: 0.8;
}

.card-ideal {
  margin-top: 4px;
  font-size: 24px;
  opacity: 0.75;
}



.modal > div {
  background: #003b5c;
  padding: 24px;
  width: 96%;
  max-width: 460px;
  border-radius: 16px;
}


/* Campos de formul√°rio */
input, textarea {
  width: 100%;
  margin-bottom: 14px;
  padding: 18px 16px;
  border-radius: 12px;
  border: none;
  font-size: 32px;
  background: #eef8fc;
  color: #003b5c;
}


/* Campo data espec√≠fico */
input[type="date"] {
  font-size: 32px;
  padding: 18px 16px;
}


/* Textarea */
textarea{
  min-height:150px;
  resize: vertical;
}

/* Ajuste geral mobile */
@media (max-width: 600px) {

  .modal > div {
    width: 96%;
    padding: 28px;
  }

  input, textarea {
    font-size: 28px;
    padding: 20px 18px;
  }

  button {
    font-size: 30px;
    padding: 14px 18px;
  }
}


.modal {
  display: none;              /* ‚Üê ESSENCIAL */
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}



.modal-content {
  background: #003b5c;
  width: 90%;
  max-width: 420px;
  max-height: 85vh;
  padding: 15px;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
}

.config-scroll {
  overflow-y: auto;
  flex: 1;
  margin: 10px 0;
  padding-right: 6px;
}


.modal-botoes {
  display: flex;
  justify-content: space-between;
  gap: 10px;
}

#cards {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  padding: 8px;
  overflow-x: hidden;
  margin-top: 15px;
}

.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.app-title {
  font-size: 44px;
  font-weight: bold;
}

.config-btn {
  background: linear-gradient(145deg, #137aa6, #0b4f6c);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  border: none;
  color: white;
  font-size: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.config-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px 32px;
  margin-top: 10px;
}





.config-item {
  display: flex;
  flex-direction: column;
  font-size: 26px;
}

.config-item label {
  color: #cfefff;
  margin-bottom: 4px;
}

.config-item input {
  height: 32px;
  padding: 4px 8px;
  border-radius: 8px;
  border: none;
  font-size: 26px;
}


.hist-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 4px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.btn-delete {
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 32px;
  opacity: 0.6;
}

.btn-delete:hover {
  opacity: 1;
}

.btn.danger {
  background: #c0392b;
  color: #fff;
  border-radius: 8px;
}

.btn.cancel {
  background: #7f8c8d;
  color: #fff;
  border-radius: 8px;
}

.config-backup {
  display: flex;
  gap: 10px;
  margin: 12px 0;
}

.btn-backup {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  background: #0a7aa8;
  color: #fff;
  border: none;
  cursor: pointer;
}



/* --- Analytics --- */
.kpi-row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin:10px 0 6px 0;
}
.kpi{
  flex:1 1 140px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 12px;
  padding: 10px 12px;
}
.kpi .kpi-label{
  font-size: 12px;
  opacity: .85;
}
.kpi .kpi-value{
  font-size: 18px;
  font-weight: 700;
  margin-top: 4px;
}
.toggle-row{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:14px;
  margin-bottom:10px;
  font-size: 22px;
}
.toggle-row input{
  transform: scale(1.4);
}
.analytics-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap:12px;
  margin:12px 0;
}
.analytics-card{
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 14px;
  padding: 12px 14px;
}
.analytics-card h4{
  margin: 0 0 8px 0;
  font-size: 16px;
}
.analytics-table{
  width:100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 14px;
}
.analytics-table th, .analytics-table td{
  border-bottom: 1px solid rgba(255,255,255,0.10);
  padding: 8px 6px;
  text-align:left;
}
.badge{
  display:inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 12px;
  border:1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.06);
}
.badge.warn{ background: rgba(241, 196, 15, 0.18); }
.badge.danger{ background: rgba(231, 76, 60, 0.18); }

</style>
</head>

<body>

<div class="topbar">
  <div class="app-title">üê† Aqu√°rio</div>
  <button class="config-btn" onclick="abrirConfig()">‚öôÔ∏è</button>
</div>


<button onclick="abrirConfig()">‚öôÔ∏è Configura√ß√µes</button>

<button onclick="abrirAnalytics()">üìä Analytics</button>

<div id="cards"></div>

<!-- MODAL MEDI√á√ÉO -->
<div id="modal" class="modal">
  <div>
    <h3 id="titulo"></h3>
    <input type="date" id="data">
    <input type="number" step="any" id="valor" placeholder="Valor">
    <textarea id="obs" placeholder="Observa√ß√µes"></textarea>
    <button onclick="salvar()">Salvar</button>
    <button onclick="abrirHistorico()">üìú Hist√≥rico</button><br><br>
    <button class="secundario" onclick="fechar()">Cancelar</button>
  </div>
</div>

<!-- MODAL HIST√ìRICO -->
<div id="historicoModal" class="modal">
  <div>
    <h3 id="histTitulo"></h3>
    <div id="listaHistorico"></div>
    <div id="grafico-container" style="margin-top:20px;">
      <div id="histKpi" class="kpi-row"></div>

      <div class="toggle-row">
      <input type="checkbox" id="chkTPA" style="transform: scale(1.6);">
      <label for="chkTPA" style="cursor:pointer;">Adicionar TPA</label>
      <span class="badge">+</span>
      <input type="checkbox" id="chkMA7">
      <label for="chkMA7" style="cursor:pointer;">M√©dia 7 dias</label>
      <input type="checkbox" id="chkIdeal">
      <label for="chkIdeal" style="cursor:pointer;">Linha ideal</label>

    </div>
    <canvas id="grafico" style="height:220px; width:100%;"></canvas>
    </div>
    <button onclick="fecharHistorico()">Fechar</button>
  </div>
</div>


<!-- MODAL ANALYTICS -->
<div id="analyticsModal" class="modal">
  <div class="modal-content">
    <h3>üìä Aquarismo Analytics</h3>

    <div id="analyticsCards" class="analytics-grid"></div>

    <div class="analytics-card">
      <h4>üìå Pend√™ncias (por intervalo)</h4>
      <div id="analyticsPendencias"></div>
    </div>

    <div class="analytics-card">
      <h4>üéØ Desvio do ideal (√∫ltimo valor)</h4>
      <div id="analyticsDesvios"></div>
    </div>

    <div class="modal-botoes">
      <button class="secundario" onclick="fecharAnalytics()">Fechar</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIG -->
<div id="configModal" class="modal">
  <div class="modal-content">
    <h3>‚öôÔ∏è Configura√ß√µes</h3>

    <div class="config-scroll">
      <div id="configCampos" class="config-grid"></div>
    </div>
<div class="config-backup">
  <button class="btn-backup" onclick="exportarDados()">üì§ Exportar Backup</button>

  <input type="file" id="importFile" accept=".json" hidden onchange="importarDados(this.files[0])">

  <button class="btn-backup" onclick="document.getElementById('importFile').click()">
    üì• Importar Backup
  </button>
</div>

    <div class="modal-botoes">
      <button onclick="salvarConfig()">Salvar</button>
      <button class="secundario" onclick="fecharConfig()">Cancelar</button>
    </div>
  </div>
</div>

<div id="confirmModal" class="modal">
  <div class="modal-box">
    <h3>Excluir registro?</h3>
    <p>Esta a√ß√£o n√£o poder√° ser desfeita.</p>
    <div class="modal-actions">
      <button class="btn cancel" onclick="fecharConfirm()">Cancelar</button>
      <button class="btn danger" onclick="confirmarExclusao()">Excluir</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

<script>
// ------------------- ITENS -------------------
const itens = [
  "TPA","Densidade","KH","Fosfato","pH",
  "Nitrito","Am√¥nia","Perlon","Phosgard","Aquapure",
  "Fuel","Carbonate","BioActive","Stability"
];

const icones = {
  TPA: "üíß",
  Densidade: "‚öñÔ∏è",
  KH: "üß™",
  Fosfato: "üß´",
  pH: "üåä",
  Nitrito: "‚ò†Ô∏è",
  Am√¥nia: "‚ò¢Ô∏è",
  Perlon: "üßª",
  Phosgard: "üß±",
  Aquapure: "üîµ",
  Fuel: "üî•",
  Carbonate: "ü™®",
  BioActive: "ü¶†",
  Stability: "‚öì"
};

const statusIcone = {
  ok: "‚úîÔ∏è",
  alerta: "‚ö†Ô∏è",
  critico: "‚ùó",
  neutro: "‚ûñ"
};


// ------------------- CONFIG -------------------
const configPadrao = {
  TPA:{dias:10, ideal:null},
  Densidade:{dias:7, ideal:1.025},
  KH:{dias:3, ideal:8},
  Fosfato:{dias:7, ideal:0.03},
  pH:{dias:3, ideal:8.2},
  Nitrito:{dias:7, ideal:0},
  Am√¥nia:{dias:7, ideal:0},
  Perlon:{dias:15, ideal:null},
  Phosgard:{dias:30, ideal:null},
  Aquapure:{dias:30, ideal:null},
  Fuel:{dias:null, ideal:null},
  Carbonate:{dias:null, ideal:null},
  BioActive:{dias:null, ideal:null},
  Stability:{dias:null, ideal:null}
};

function carregarConfig(){
  let cfgSalvo = JSON.parse(localStorage.getItem("config")) || {};
  let cfgFinal = {};

  itens.forEach(nome => {
    cfgFinal[nome] = {
      dias: cfgSalvo[nome]?.dias ?? configPadrao[nome].dias,
      ideal: cfgSalvo[nome]?.ideal ?? configPadrao[nome].ideal
    };
  });

  localStorage.setItem("config", JSON.stringify(cfgFinal));
  return cfgFinal;
}


// ------------------- UTIL -------------------
function diasDesde(dataStr){
  if(!dataStr) return "Nunca";
  const hoje = new Date();
  const data = new Date(dataStr);
  const diff = hoje - data;
  const dias = Math.floor(diff / (1000*60*60*24));
  if(dias===0) return "Hoje";
  if(dias===1) return "1 dia";
  return dias+" dias";
}

function classeAlerta(diasStr, limite){
  // Sem intervalo definido ‚Üí sempre neutro
  if (limite === null || isNaN(limite)) return "neutro";

  if(diasStr==="Nunca") return "neutro";
  if(diasStr==="Hoje") return "ok";

  const dias = parseInt(diasStr);
  if(isNaN(dias)) return "neutro";

  if(dias < limite*0.8) return "ok";
  if(dias <= limite) return "alerta";
  return "critico";
}


// ------------------- TELA PRINCIPAL -------------------
function carregar(){
  const cards = document.getElementById("cards");
  const cfg = carregarConfig();
  cards.innerHTML = "";

  itens.forEach(nome=>{
    const hist = JSON.parse(localStorage.getItem(nome)||"[]");
    const temHistorico = hist.length > 0;
    const ultimaData = obterUltimaData(hist);
    const diasStr = diasDesde(ultimaData);
    const limite = cfg[nome].dias;
    const classe = classeAlerta(diasStr, limite);

    const div = document.createElement("div");
    div.className = "card "+classe;
    div.innerHTML = `
      <div class="card-header">
        <div class="card-icon">${icones[nome] || "üê†"}</div>
        <div class="card-title">${nome}</div>
      </div>

      <div class="card-days">
        ${
          !temHistorico
            ? "‚Äî<span>sem dados</span>"
            : diasStr === "Hoje"
              ? "Hoje"
              : diasStr === "1 dia"
                ? "1<span>dia</span>"
                : `${diasStr.replace(" dias","")}<span> dias</span>`
        }
      </div>


      <div class="card-ideal">
        ${limite ? `Ideal: ${limite} dias` : "Sem intervalo"}
      </div>
      <div class="card-status">${statusIcone[classe]}</div>

    `;
    div.onclick = ()=>abrir(nome);
    cards.appendChild(div);
  });
}

// ------------------- MEDI√á√ïES -------------------
let atual = null;
let indiceEdicao = null;
let excluirItem = null;
let excluirId = null;


function abrir(nome){
  if (!nome) return;
  fecharTodosModais();   // ‚Üê ADICIONAR
  atual = nome;
  indiceEdicao = null;
  document.getElementById("titulo").innerText = nome;
  const hoje = new Date().toISOString().split("T")[0];
  document.getElementById("data").value = hoje;
  document.getElementById("valor").value = "";
  document.getElementById("obs").value = "";
  document.getElementById("modal").style.display = "flex";
}


function fechar(){
  document.getElementById("modal").style.display="none";
}

function salvar() {
  let hist = JSON.parse(localStorage.getItem(atual) || "[]");

  const novo = {
    id: indiceEdicao || crypto.randomUUID(),
    data: document.getElementById("data").value,
    valor: document.getElementById("valor").value,
    obs: document.getElementById("obs").value
  };

  if (indiceEdicao) {
    hist = hist.map(r => r.id === indiceEdicao ? novo : r);
    indiceEdicao = null;
  } else {
    hist.push(novo);
  }

  localStorage.setItem(atual, JSON.stringify(hist));
  normalizarHistorico(atual);

  fechar();
  carregar();
}

// ------------------- HIST√ìRICO -------------------
function abrirHistorico() {
  if (!atual) return;

  fecharTodosModais();

  document.getElementById("histTitulo").innerText = atual;
  const lista = document.getElementById("listaHistorico");
  lista.innerHTML = "";

  // üîë SEMPRE normaliza antes
  const hist = normalizarHistorico(atual).slice().reverse();

  hist.forEach(item => {
    lista.innerHTML += `
      <div class="hist-item">
        <div>
          <strong>${item.data}</strong> ‚Äî ${item.valor}<br>
          ${item.obs || ""}
        </div>
        <div>
          <button onclick="editarMedicao('${item.id}')">‚úèÔ∏è</button>
          <button class="btn-delete" onclick="pedirExclusao('${atual}','${item.id}')">üóëÔ∏è</button>
        </div>
      </div>
    `;
  });



// Toggles do gr√°fico
const chkTPA = document.getElementById("chkTPA");
if (chkTPA) {
  chkTPA.checked = getMostrarTPA();
  chkTPA.onchange = () => { setMostrarTPA(chkTPA.checked); desenharGrafico(atual); };
}
const chkMA7 = document.getElementById("chkMA7");
if (chkMA7) {
  chkMA7.checked = getMostrarMA7();
  chkMA7.onchange = () => { setMostrarMA7(chkMA7.checked); desenharGrafico(atual); };
}
const chkIdeal = document.getElementById("chkIdeal");
if (chkIdeal) {
  chkIdeal.checked = getMostrarIdeal();
  chkIdeal.onchange = () => { setMostrarIdeal(chkIdeal.checked); desenharGrafico(atual); };
}

desenharGrafico(atual);

  document.getElementById("historicoModal").style.display = "block";
}


function excluirRegistro(nome, indice) {
  if (!confirm("Deseja realmente excluir este registro?")) return;

  const hist = JSON.parse(localStorage.getItem(nome) || "[]");
  hist.splice(indice, 1);
  localStorage.setItem(nome, JSON.stringify(hist));

  abrir(nome);   // reabre o modal do item
  carregar();   // atualiza os cards
}



function fecharHistorico(){
  document.getElementById("historicoModal").style.display="none";
}

function editarMedicao(id) {
  const hist = JSON.parse(localStorage.getItem(atual) || "[]");
  const registro = hist.find(r => r.id === id);
  if (!registro) return;

  indiceEdicao = id;

  document.getElementById("data").value = registro.data;
  document.getElementById("valor").value = registro.valor;
  document.getElementById("obs").value = registro.obs || "";

  document.getElementById("modal").style.display = "flex";
}



function fecharTodosModais(){
  document.getElementById("modal").style.display = "none";
  document.getElementById("configModal").style.display = "none";
  document.getElementById("historicoModal").style.display = "none";
  const am = document.getElementById("analyticsModal");
  if (am) am.style.display = "none";
}


// ------------------- CONFIG -------------------
function abrirConfig(){
  fecharTodosModais();
  const cfg = carregarConfig();
  const div = document.getElementById("configCampos");
  div.innerHTML="";
  itens.forEach(nome=>{
    div.innerHTML+=`
      <div class="config-item"><label>${nome} ‚Äì Intervalo (dias)</label>
      <input type="number" id="dias_${nome}" value="${cfg[nome].dias}">
      <label>${nome} ‚Äì Valor ideal</label>
      <input type="number" step="any" id="ideal_${nome}" value="${cfg[nome].ideal??""}"></div>
    `;
  });
  document.getElementById("configModal").style.display="flex";
}

function fecharConfig(){
  document.getElementById("configModal").style.display="none";
}

function obterUltimaData(historico) {
  if (!historico.length) return null;

  let maisRecente = historico[0];

  historico.forEach(item => {
    if (new Date(item.data) > new Date(maisRecente.data)) {
      maisRecente = item;
    }
  });

  return maisRecente.data;
}

function salvarConfig(){
  const cfg = {};
  itens.forEach(nome=>{
    cfg[nome]={
      dias:parseInt(document.getElementById("dias_"+nome).value),
      ideal:parseFloat(document.getElementById("ideal_"+nome).value)
    };
  });
  localStorage.setItem("config", JSON.stringify(cfg));
  fecharConfig();
  carregar();
}

function fecharConfirm() {
  document.getElementById("confirmModal").style.display = "none";
}



function pedirExclusao(item, id) {
  excluirItem = item;
  excluirId = id;
  document.getElementById("confirmModal").style.display = "flex";
}

function confirmarExclusao() {
  let hist = JSON.parse(localStorage.getItem(excluirItem) || "[]");

  hist = hist.filter(r => r.id !== excluirId);

  localStorage.setItem(excluirItem, JSON.stringify(hist));
  normalizarHistorico(excluirItem);

  fecharConfirm();
  abrirHistorico();
  carregar();
}



function exportarDados() {
  const backup = {
    versao: 2,
    dataExportacao: new Date().toISOString(),
    configuracoes: JSON.parse(localStorage.getItem("config") || "{}"),
    dados: {}
  };

  itens.forEach(nome => {
    const hist = JSON.parse(localStorage.getItem(nome) || "[]");

    backup.dados[nome] = hist.map(r => ({
      id: r.id || crypto.randomUUID(),
      data: r.data,
      valor: r.valor,
      obs: r.obs || ""
    }));
  });

  const blob = new Blob(
    [JSON.stringify(backup, null, 2)],
    { type: "application/json" }
  );

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "backup_aquario.json";
  a.click();
}



function importarDados(file) {

  if (!file) {
    alert("Nenhum arquivo selecionado.");
    return;
  }

  const reader = new FileReader();

  reader.onload = e => {
    try {
      const backup = JSON.parse(e.target.result);

      if (!backup || !backup.dados) {
        alert("Arquivo de backup inv√°lido.");
        return;
      }

      /* =========================
         CONFIGURA√á√ïES
      ========================= */
      if (backup.configuracoes) {
        localStorage.setItem(
          "config",
          JSON.stringify(backup.configuracoes)
        );
      }

      /* =========================
         DADOS
      ========================= */
      Object.keys(backup.dados).forEach(nome => {

        let hist = Array.isArray(backup.dados[nome])
          ? backup.dados[nome]
          : [];

        hist = hist.map(r => ({
          id: r.id || crypto.randomUUID(),
          data: r.data,
          valor: r.valor,
          obs: r.obs || ""
        }));

        // ordena sempre
        hist.sort((a, b) => new Date(a.data) - new Date(b.data));

        localStorage.setItem(nome, JSON.stringify(hist));
      });

      alert("Backup importado com sucesso!");

      fecharTodosModais();
      carregar();

    } catch (err) {
      console.error(err);
      alert("Erro ao importar o backup. Arquivo inv√°lido.");
    }
  };

  reader.onerror = () => {
    alert("Erro ao ler o arquivo.");
  };

  reader.readAsText(file);
}


let graficoAtual = null;
// ------------------- MARCA√á√ÉO DE TPA NO GR√ÅFICO -------------------
// L√™ o hist√≥rico de "TPA" e devolve timestamps (ms) normalizados para 00:00 do dia.
function obterTpaTimestamps() {
  const histTpa = JSON.parse(localStorage.getItem("TPA") || "[]");
  if (!Array.isArray(histTpa) || histTpa.length === 0) return [];

  // normaliza para YYYY-MM-DD e depois para timestamp do in√≠cio do dia (local)
  const diasUnicos = new Set(
    histTpa
      .map(r => (r?.data || "").slice(0, 10))
      .filter(Boolean)
  );

  const ts = [];
  diasUnicos.forEach(dia => {
    const d = new Date(dia + "T00:00:00");
    const t = d.getTime();
    if (Number.isFinite(t)) ts.push(t);
  });

  ts.sort((a, b) => a - b);
  return ts;
}

// Plugin simples para desenhar linhas verticais nas datas de TPA
const tpaLinesPlugin = {
  id: "tpaLines",
  afterDraw(chart, args, opts) {
    if (!opts || !opts.enabled) return;

    const xs = Array.isArray(opts.xs) ? opts.xs : [];
    if (xs.length === 0) return;

    const { ctx, chartArea, scales } = chart;
    const xScale = scales?.x;
    if (!xScale) return;

    ctx.save();
    ctx.lineWidth = opts.lineWidth ?? 2;
    ctx.setLineDash(opts.dash ?? [6, 6]);
    ctx.strokeStyle = opts.color ?? "rgba(255,255,255,0.45)";

    ctx.beginPath();
    for (const xVal of xs) {
      const px = xScale.getPixelForValue(xVal);
      if (!Number.isFinite(px)) continue;
      ctx.moveTo(px, chartArea.top);
      ctx.lineTo(px, chartArea.bottom);
    }
    ctx.stroke();
    ctx.restore();
  }
};

// Estado do checkbox (persistido)
function getMostrarTPA() {
  return localStorage.getItem("mostrarTPA") === "1";
}
function setMostrarTPA(v) {
  localStorage.setItem("mostrarTPA", v ? "1" : "0");
}


// Estado dos toggles do gr√°fico (persistidos)
function getMostrarMA7(){ return localStorage.getItem("mostrarMA7")==="1"; }
function setMostrarMA7(v){ localStorage.setItem("mostrarMA7", v ? "1":"0"); }
function getMostrarIdeal(){ return localStorage.getItem("mostrarIdeal")==="1"; }
function setMostrarIdeal(v){ localStorage.setItem("mostrarIdeal", v ? "1":"0"); }

// Util num√©rica
function isNumero(v){ return typeof v === "number" && Number.isFinite(v); }
function round(v, casas=2){
  if(!isNumero(v)) return "‚Äî";
  const f = Math.pow(10, casas);
  return (Math.round(v*f)/f).toString().replace(".", ",");
}

// KPIs para o hist√≥rico (√∫ltimos N dias)
function filtrarPorDias(pontos, dias){
  const agora = Date.now();
  const lim = agora - dias*24*60*60*1000;
  return pontos.filter(p => p.x >= lim);
}

function statsBasicos(pontos){
  if(!pontos.length) return null;
  const ys = pontos.map(p=>p.y).filter(isNumero);
  if(!ys.length) return null;
  const min = Math.min(...ys);
  const max = Math.max(...ys);
  const avg = ys.reduce((a,b)=>a+b,0)/ys.length;
  const last = pontos[pontos.length-1].y;
  return {min,max,avg,last};
}

// Tend√™ncia via regress√£o linear simples (slope em "unidades por dia")
function slopePorDia(pontos){
  if(pontos.length < 2) return null;
  const xs = pontos.map(p=>p.x);
  const ys = pontos.map(p=>p.y);
  const n = pontos.length;
  const meanX = xs.reduce((a,b)=>a+b,0)/n;
  const meanY = ys.reduce((a,b)=>a+b,0)/n;
  let num = 0, den = 0;
  for(let i=0;i<n;i++){
    const dx = xs[i]-meanX;
    num += dx*(ys[i]-meanY);
    den += dx*dx;
  }
  if(den === 0) return null;
  const slopePerMs = num/den;
  return slopePerMs * 24*60*60*1000; // por dia
}

// M√©dia m√≥vel por janela em dias (time-based)
function mediaMovelPorDias(pontos, dias){
  const janelaMs = dias*24*60*60*1000;
  const out = [];
  let i0 = 0;
  let soma = 0;
  let count = 0;
  // Usamos uma fila simples
  const fila = [];
  for(const p of pontos){
    const x = p.x, y = p.y;
    // expira
    while(fila.length && (x - fila[0].x) > janelaMs){
      const r = fila.shift();
      soma -= r.y;
      count -= 1;
    }
    fila.push({x,y});
    soma += y;
    count += 1;
    out.push({x, y: count ? soma/count : null});
  }
  return out;
}

// Efeito m√©dio p√≥s-TPA: encontra medi√ß√£o mais pr√≥xima antes/depois (at√© 2 dias)
function efeitoPosTPA(pontos, tpaTs){
  if(!pontos.length || !tpaTs.length) return null;
  const maxDist = 2*24*60*60*1000;
  const deltas = [];
  for(const t of tpaTs){
    // antes
    let antes = null;
    for(let i=pontos.length-1;i>=0;i--){
      if(pontos[i].x <= t && (t - pontos[i].x) <= maxDist){ antes = pontos[i]; break; }
      if(pontos[i].x < t - maxDist) break;
    }
    // depois
    let depois = null;
    for(let i=0;i<pontos.length;i++){
      if(pontos[i].x >= t && (pontos[i].x - t) <= maxDist){ depois = pontos[i]; break; }
      if(pontos[i].x > t + maxDist) break;
    }
    if(antes && depois && isNumero(antes.y) && isNumero(depois.y)){
      deltas.push(depois.y - antes.y);
    }
  }
  if(!deltas.length) return null;
  return deltas.reduce((a,b)=>a+b,0)/deltas.length;
}

function atualizarKpisHistorico(item, pontos){
  const div = document.getElementById("histKpi");
  if(!div) return;

  const p30 = filtrarPorDias(pontos, 30);
  const st = statsBasicos(p30);
  const sl = slopePorDia(p30);
  const cfg = carregarConfig();
  const ideal = cfg?.[item]?.ideal;
  const eff = efeitoPosTPA(pontos, obterTpaTimestamps());

  const tendencia = (sl===null) ? "‚Äî" : (sl>0 ? `‚ñ≤ ${round(sl,3)}/dia` : `‚ñº ${round(Math.abs(sl),3)}/dia`);
  const desvioIdeal = (isNumero(ideal) && st && isNumero(st.last)) ? (st.last - ideal) : null;

  div.innerHTML = `
    <div class="kpi"><div class="kpi-label">√öltimo</div><div class="kpi-value">${st?round(st.last):"‚Äî"}</div></div>
    <div class="kpi"><div class="kpi-label">M√©dia 30d</div><div class="kpi-value">${st?round(st.avg):"‚Äî"}</div></div>
    <div class="kpi"><div class="kpi-label">Min/Max 30d</div><div class="kpi-value">${st?`${round(st.min)} / ${round(st.max)}`:"‚Äî"}</div></div>
    <div class="kpi"><div class="kpi-label">Tend√™ncia 30d</div><div class="kpi-value">${tendencia}</div></div>
    <div class="kpi"><div class="kpi-label">P√≥s-TPA (m√©dio)</div><div class="kpi-value">${eff===null?"‚Äî":(eff>0?`+${round(eff)}`:round(eff))}</div></div>
    <div class="kpi"><div class="kpi-label">Desvio do ideal</div><div class="kpi-value">${desvioIdeal===null?"‚Äî":(desvioIdeal>0?`+${round(desvioIdeal)}`:round(desvioIdeal))}</div></div>
  `;
}

// ------------------- MODAL ANALYTICS -------------------
function abrirAnalytics(){
  fecharTodosModais();
  document.getElementById("analyticsModal").style.display="flex";
  renderAnalytics();
}

function fecharAnalytics(){
  document.getElementById("analyticsModal").style.display="none";
}

function ultimaTPAData(){
  const hist = JSON.parse(localStorage.getItem("TPA")||"[]");
  if(!hist.length) return null;
  let max = hist[0].data;
  for(const r of hist){
    if(new Date(r.data) > new Date(max)) max = r.data;
  }
  return max;
}

function mediaIntervaloTPA(){
  const ts = obterTpaTimestamps();
  if(ts.length < 2) return null;
  let soma = 0;
  for(let i=1;i<ts.length;i++){
    soma += (ts[i]-ts[i-1]);
  }
  const mediaMs = soma/(ts.length-1);
  return mediaMs/(24*60*60*1000);
}

function renderAnalytics(){
  const cards = document.getElementById("analyticsCards");
  const pend = document.getElementById("analyticsPendencias");
  const desv = document.getElementById("analyticsDesvios");
  if(!cards || !pend || !desv) return;

  const cfg = carregarConfig();

  // Cards topo: TPA
  const uTPA = ultimaTPAData();
  const mTPA = mediaIntervaloTPA();

  cards.innerHTML = `
    <div class="analytics-card">
      <h4>üíß TPAs</h4>
      <div><span class="badge">√öltima</span> ${uTPA ? new Date(uTPA).toLocaleDateString("pt-BR") : "‚Äî"}</div>
      <div style="margin-top:6px;"><span class="badge">Intervalo m√©dio</span> ${mTPA===null ? "‚Äî" : `${round(mTPA,1)} dias`}</div>
    </div>
    <div class="analytics-card">
      <h4>üóÇÔ∏è Base de dados</h4>
      <div><span class="badge">Itens</span> ${itens.length}</div>
      <div style="margin-top:6px;"><span class="badge">Registros</span> ${itens.reduce((a,n)=>a + (JSON.parse(localStorage.getItem(n)||"[]").length),0)}</div>
    </div>
  `;

  // Pend√™ncias por intervalo (top 6)
  const pendencias = [];
  itens.forEach(nome=>{
    const hist = JSON.parse(localStorage.getItem(nome)||"[]");
    const ultima = obterUltimaData(hist);
    const diasStr = diasDesde(ultima);
    const limite = cfg?.[nome]?.dias;
    if(!limite || limite===null || isNaN(limite)) return;
    const dias = (diasStr==="Hoje") ? 0 : (diasStr==="1 dia") ? 1 : (diasStr==="Nunca") ? null : parseInt(diasStr);
    if(dias===null || isNaN(dias)) return;
    const atraso = dias - limite;
    pendencias.push({nome, dias, limite, atraso});
  });

  pendencias.sort((a,b)=> b.atraso - a.atraso);
  const topPend = pendencias.slice(0, 6);

  pend.innerHTML = `
    <table class="analytics-table">
      <thead><tr><th>Item</th><th>√öltima</th><th>Ideal</th><th>Status</th></tr></thead>
      <tbody>
        ${topPend.map(p=>{
          const st = p.atraso <= 0 ? "ok" : (p.atraso <= p.limite*0.2 ? "warn" : "danger");
          const badge = st==="ok" ? '<span class="badge">OK</span>' : st==="warn" ? '<span class="badge warn">Aten√ß√£o</span>' : '<span class="badge danger">Atrasado</span>';
          return `<tr><td>${p.nome}</td><td>${p.dias}d</td><td>${p.limite}d</td><td>${badge}</td></tr>`;
        }).join("")}
      </tbody>
    </table>
  `;

  // Desvio do ideal (top 6)
  const desvios = [];
  itens.forEach(nome=>{
    const ideal = cfg?.[nome]?.ideal;
    if(!isNumero(ideal)) return;
    const hist = JSON.parse(localStorage.getItem(nome)||"[]");
    if(!hist.length) return;
    hist.sort((a,b)=> new Date(a.data)-new Date(b.data));
    const last = Number(hist[hist.length-1].valor);
    if(!isNumero(last)) return;
    desvios.push({nome, last, ideal, diff: last-ideal, abs: Math.abs(last-ideal)});
  });
  desvios.sort((a,b)=> b.abs - a.abs);
  const topDesv = desvios.slice(0, 6);

  desv.innerHTML = topDesv.length ? `
    <table class="analytics-table">
      <thead><tr><th>Item</th><th>√öltimo</th><th>Ideal</th><th>Œî</th></tr></thead>
      <tbody>
        ${topDesv.map(d=>{
          const delta = d.diff;
          const txt = delta>0 ? `+${round(delta)}` : round(delta);
          return `<tr><td>${d.nome}</td><td>${round(d.last)}</td><td>${round(d.ideal)}</td><td>${txt}</td></tr>`;
        }).join("")}
      </tbody>
    </table>
  ` : "<div>Defina valores ideais nas Configura√ß√µes para ver este ranking.</div>";
}


function prepararDadosGrafico(item) {
  const hist = JSON.parse(localStorage.getItem(item) || "[]");
  if (hist.length === 0) return [];

  hist.sort((a, b) => new Date(a.data) - new Date(b.data));

  return hist.map(r => ({
    x: new Date(r.data).getTime(), // üëà timestamp (n√∫mero)
    y: Number(r.valor)
  }));
}







function desenharGrafico(item) {
  const canvas = document.getElementById("grafico");
  if (!canvas) return;

  const pontos = prepararDadosGrafico(item);
  if (pontos.length === 0) return;

  // KPIs
  atualizarKpisHistorico(item, pontos);

  if (graficoAtual) graficoAtual.destroy();

  const datasets = [{
    label: item,
    data: pontos,
    parsing: false,
    borderColor: "#4fc3f7",
    backgroundColor: "rgba(79,195,247,0.2)",
    tension: 0.3,
    pointRadius: 4
  }];

  // M√©dia m√≥vel 7 dias
  if (getMostrarMA7()) {
    const ma = mediaMovelPorDias(pontos, 7);
    datasets.push({
      label: "M√©dia 7 dias",
      data: ma,
      parsing: false,
      borderColor: "rgba(255,255,255,0.65)",
      backgroundColor: "rgba(255,255,255,0.08)",
      tension: 0.25,
      pointRadius: 0,
      borderWidth: 2
    });
  }

  // Linha ideal (se configurada)
  if (getMostrarIdeal()) {
    const cfg = carregarConfig();
    const ideal = cfg?.[item]?.ideal;
    if (typeof ideal === "number" && Number.isFinite(ideal)) {
      const minX = pontos[0].x;
      const maxX = pontos[pontos.length - 1].x;
      datasets.push({
        label: "Ideal",
        data: [{x:minX, y: ideal},{x:maxX, y: ideal}],
        parsing: false,
        borderColor: "rgba(46, 204, 113, 0.85)",
        borderWidth: 2,
        pointRadius: 0,
        tension: 0
      });
    }
  }

  graficoAtual = new Chart(canvas.getContext("2d"), {
    type: "line",
    plugins: [tpaLinesPlugin],
    data: { datasets },
    options: {
      responsive: true,
      plugins: {
        tpaLines: {
          enabled: getMostrarTPA(),
          xs: obterTpaTimestamps(),
          lineWidth: 2,
          dash: [6, 6],
          color: "rgba(255,255,255,0.45)"
        },
        legend: { display: true }
      },
      scales: {
        x: {
          type: "linear",
          title: { display: true, text: "Data" },
          ticks: {
            callback: value => new Date(value).toLocaleDateString("pt-BR")
          }
        },
        y: {
          title: { display: true, text: "Valor" }
        }
      }
    }
  });
}

function normalizarHistoricofunction normalizarHistorico(nome) {
  const hist = JSON.parse(localStorage.getItem(nome) || "[]");

  hist.sort((a, b) => new Date(a.data) - new Date(b.data));

  localStorage.setItem(nome, JSON.stringify(hist));
  return hist;
}


// ------------------- INIT -------------------
carregar();


if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker registrado"))
    .catch(err => console.error("SW erro", err));
}



</script>





</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#003f5c">
<meta charset="UTF-8">
<title>Aqu√°rio ‚Äì Manuten√ß√£o</title>

<style>
* {
  box-sizing: border-box;
}


body {
  background:#002b3d;
  color:white;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  font-size: 20px;
  padding:0px;
  margin: 0;
  overflow-x: hidden;
  width: 100%;
  max-width: 100%;
}

h2 {
  margin-bottom:10px;
}
#titulo {
  font-size: 2rem;   /* ajuste fino aqui */
  font-weight: 600;
  margin-bottom: 12px;
  text-align: center;
  letter-spacing: 0.5px;
}
  
@media (max-width: 600px) {
  #titulo {
    font-size: 1.8rem;
  }
}

  
button {
  background: linear-gradient(145deg, #1fa2d6, #137aa6);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 12px;
  padding: 10px 14px;
  color: white;
  font-size: 20px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.35);
}

button:active {
  transform: translateY(0);
  box-shadow: 0 3px 8px rgba(0,0,0,0.25);
}

button.secundario {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.14);
  color: rgba(255,255,255,0.86);
  font-weight: 650;
}

.btn-secondary{
  background: transparent;
  border: 1px solid rgba(77,208,225,0.50);
  color: rgba(220,250,255,0.95);
}
.btn-secondary:hover{
  background: rgba(77,208,225,0.10);
  box-shadow: 0 6px 14px rgba(0,0,0,0.35);
}

.btn-primary{
  background: linear-gradient(145deg, #1fa2d6, #137aa6);
  border: 1px solid rgba(255,255,255,0.12);
  color: #fff;
}
.btn-danger{
  background: rgba(255,107,107,0.20);
  border: 1px solid rgba(255,107,107,0.40);
  color: rgba(255,235,235,0.98);
  box-shadow: 0 0 0 rgba(0,0,0,0), 0 0 18px rgba(255,107,107,0.30);
}



@keyframes fadeUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}


@keyframes pulse {
  0%   { box-shadow: 0 0 0 rgba(241,196,15,0.0); }
  50%  { box-shadow: 0 0 12px rgba(241,196,15,0.6); }
  100% { box-shadow: 0 0 0 rgba(241,196,15,0.0); }
}

.card.alerta {
  animation: pulse 2.5s infinite;
}

@keyframes pulseRed {
  0%   { box-shadow: 0 0 0 rgba(255,107,107,0.0); }
  50%  { box-shadow: 0 0 14px rgba(255,107,107,0.6); }
  100% { box-shadow: 0 0 0 rgba(255,107,107,0.0); }
}

.hidden {
  display: none;
}

.card.critico {
  animation: pulseRed 2s infinite;
}


.card {
  background: linear-gradient(145deg, #014f6e, #00384f);
  border-radius: 18px;
  padding: 18px;
  color: #fff;
  cursor: pointer;
  box-shadow: 0 6px 14px rgba(0,0,0,0.35);
  transition: transform 0.2s, box-shadow 0.2s;
  animation: fadeUp 0.35s ease both;
  position: relative; /* permite sobreposi√ß√£o */
  width: 100%;
  max-width: 100%;
  overflow: hidden;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.45);
}

/* Cores de status */
.card.ok       { border-left: 8px solid rgba(59,214,113,0.75); }
.card.alerta   { border-left: 8px solid rgba(241,196,15,0.75); }
.card.critico  { border-left: 8px solid rgba(255,107,107,0.78); }
.card.neutro   { border-left: 8px solid rgba(127,140,141,0.70); }




.card-header {
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-status{
  position:absolute;
  top: 12px;
  right: 12px;
  font-size: 18px;
  padding: 7px 12px;
  border-radius: 999px;
  font-weight: 800;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  opacity: 0.95;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}

.card.ok .card-status{
  background: rgba(59,214,113,0.28);
  border: 1px solid rgba(59,214,113,0.35);
  color: rgba(230,255,240,0.95);
}
.card.alerta .card-status{
  background: rgba(241,196,15,0.28);
  border: 1px solid rgba(241,196,15,0.35);
  color: rgba(255,250,210,0.95);
}
.card.critico .card-status{
  background: rgba(255,107,107,0.30);
  border: 1px solid rgba(255,107,107,0.35);
  color: rgba(255,235,235,0.98);
  box-shadow: 0 0 0 rgba(0,0,0,0), 0 0 18px rgba(255,107,107,0.30);
}
.card.neutro .card-status{
  background: rgba(127,140,141,0.26);
  border: 1px solid rgba(127,140,141,0.30);
  color: rgba(240,245,245,0.92);
}

/* "tinta" suave para enxergar prioridade sem moldura neon */
.card.ok::after,
.card.alerta::after,
.card.critico::after,
.card.neutro::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  opacity:0.9;
}
.card.ok::after{ background: linear-gradient(90deg, rgba(59,214,113,0.12), transparent 60%); }
.card.alerta::after{ background: linear-gradient(90deg, rgba(241,196,15,0.12), transparent 60%); }
.card.critico::after{ background: linear-gradient(90deg, rgba(255,107,107,0.12), transparent 60%); }
.card.neutro::after{ background: linear-gradient(90deg, rgba(127,140,141,0.10), transparent 60%); }


.card-icon {
  font-size: 48px;
  max-width: 100%;
  line-height: 1;
}

.card-title {
  font-size: 28px;
  font-weight: bold;
  line-height: 1.2;
  word-break: break-word;
  flex: 1;              /* ‚Üê ocupa o espa√ßo dispon√≠vel */
}


.card-body {
  font-size: 28px;
  opacity: 0.95;
}

.card-body .ideal {
  margin-top: 4px;
  font-size: 26px;
  opacity: 0.85;
}


.card-days {
  font-size: 52px;
  font-weight: bold;
  margin-top: 8px;
}

.card-days span {
  font-size: 26px;
  font-weight: normal;
  opacity: 0.8;
}

.card-ideal {
  margin-top: 4px;
  font-size: 24px;
  opacity: 0.75;
}



.modal > div {
  background: #003b5c;
  padding: 24px;
  width: 96%;
  max-width: 460px;
  border-radius: 16px;
}


/* Campos de formul√°rio */
input, textarea {
  width: 100%;
  margin-bottom: 14px;
  padding: 18px 16px;
  border-radius: 12px;
  border: none;
  font-size: 32px;
  background: #eef8fc;
  color: #003b5c;
}


/* Campo data espec√≠fico */
input[type="date"] {
  font-size: 32px;
  padding: 18px 16px;
}


/* Textarea */
textarea{
  min-height:150px;
  resize: vertical;
}

/* Ajuste geral mobile */
@media (max-width: 600px) {

  .modal > div {
    width: 96%;
    padding: 28px;
  }

  input, textarea {
    font-size: 28px;
    padding: 20px 18px;
  }

  button {
    font-size: 30px;
    padding: 14px 18px;
  }
}


.modal {
  display: none;              /* ‚Üê ESSENCIAL */
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}



.modal-content {
  background: #003b5c;
  width: 90%;
  max-width: 420px;
  max-height: 85vh;
  padding: 15px;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
}

.config-scroll {
  overflow-y: auto;
  flex: 1;
  margin: 10px 0;
  padding-right: 6px;
}


.modal-botoes {
  display: flex;
  justify-content: space-between;
  gap: 10px;
}

#cards {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  padding: 8px;
  overflow-x: hidden;
  margin-top: 15px;
}

.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.app-title {
  font-size: 44px;
  font-weight: bold;
}

.config-btn {
  background: linear-gradient(145deg, #137aa6, #0b4f6c);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  border: none;
  color: white;
  font-size: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.config-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px 32px;
  margin-top: 10px;
}





.config-item {
  display: flex;
  flex-direction: column;
  font-size: 26px;
}

.config-item label {
  color: #cfefff;
  margin-bottom: 4px;
}

.config-item input {
  height: 32px;
  padding: 4px 8px;
  border-radius: 8px;
  border: none;
  font-size: 26px;
}


.hist-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 4px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.btn-delete {
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 32px;
  opacity: 0.6;
}

.btn-delete:hover {
  opacity: 1;
}

.btn.danger {
  background: #c0392b;
  color: #fff;
  border-radius: 8px;
}

.btn.cancel {
  background: #7f8c8d;
  color: #fff;
  border-radius: 8px;
}

.config-backup {
  display: flex;
  gap: 10px;
  margin: 12px 0;
}

.btn-backup {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  background: #0a7aa8;
  color: #fff;
  border: none;
  cursor: pointer;
}



/* --- Analytics --- */
.kpi-row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin:10px 0 6px 0;
}
.kpi{
  flex:1 1 140px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 12px;
  padding: 10px 12px;
}
.kpi .kpi-label{
  font-size: 14px;
  opacity: .85;
}
.kpi .kpi-value{
  font-size: 20px;
  font-weight: 700;
  margin-top: 4px;
}
.toggle-row{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:14px;
  margin-bottom:10px;
  font-size: 22px;
}
.toggle-row input{
  transform: scale(1.4);
}
.analytics-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap:12px;
  margin:12px 0;
}
.analytics-card{
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 14px;
  padding: 12px 14px;
}
.analytics-card h4{
  margin: 0 0 8px 0;
  font-size: 20px;
}
.analytics-table{
  width:100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 14px;
}
.analytics-table th, .analytics-table td{
  border-bottom: 1px solid rgba(255,255,255,0.10);
  padding: 8px 6px;
  text-align:left;
}
.badge{
  display:inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 14px;
  border:1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.06);
}
.badge.warn{ background: rgba(241, 196, 15, 0.18); }
.badge.danger{ background: rgba(231, 76, 60, 0.18); }

/* ===== Hist√≥rico (tabs + layout) ===== */
.modal-content.modal-historico{
  max-width: 900px;
  width: min(920px, 96vw);
}

.hist-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}

.hist-tabs{
  display:flex;
  gap:8px;
  padding:6px;
  background: rgba(255,255,255,0.06);
  border-radius:14px;
  position: sticky;
  top: 0;
  z-index: 2;
}

.tab-btn{
  flex:1;
  border:0;
  border-radius:12px;
  padding:12px 12px;
  background: transparent;
  color: rgba(255,255,255,0.88);
  font-weight: 700;
  font-size: 20px;
  cursor:pointer;
}

.tab-btn.active{
  background: rgba(255,255,255,0.12);
  color: #fff;
  box-shadow: 0 8px 20px rgba(0,0,0,0.18);
}

.hist-body{ margin-top: 10px; }

.tab-panel{ display:none; }
.tab-panel.active{ display:block; }

.hist-list{
  max-height: 46vh;
  overflow-y: auto;
  padding-right: 6px;
}

.hist-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  padding:12px 14px;
  margin:8px 0;
  background: rgba(255,255,255,0.06);
  border-radius:14px;
}

.hist-item .hist-left{
  min-width: 0;
}

.hist-item .hist-date{
  font-size: 0.92rem;
  opacity: 0.9;
}

.hist-item .hist-value{
  font-size: 1.15rem;
  font-weight: 700;
}

.hist-item .hist-obs{
  margin-top:4px;
  font-size: 0.9rem;
  opacity: 0.8;
  word-break: break-word;
}

.hist-actions{
  display:flex;
  gap:8px;
  flex-shrink:0;
}

.icon-btn{
  padding: 8px 10px;
  border: 0;
  border-radius: 12px;
  background: rgba(255,255,255,0.10);
  color: #fff;
  cursor:pointer;
  font-size: 20px;
  line-height: 1;
}

.icon-btn:hover{
  background: rgba(255,255,255,0.16);
}

.icon-btn.danger{
  background: rgba(255, 70, 70, 0.18);
}

.icon-btn.danger:hover{
  background: rgba(255, 70, 70, 0.28);
}

.toggle-chips{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

.chip{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 14px;
  border-radius:999px;
  background: rgba(255,255,255,0.06);
  cursor:pointer;
  user-select:none;
}

.chip input{
  transform: scale(1.35);
  accent-color: #4dd0e1;
}

.muted{
  opacity: 0.90;
}

.full-width{ width:100%; }

.hist-chart{
  width:100%;
  height: 260px;
}

/* Mobile tweaks */
@media (max-width: 520px){
  .hist-chart{ height: 220px; }
  .hist-list{ max-height: 52vh; }
}


/* ----- Calend√°rio (Hist√≥rico sem gr√°fico) ----- */
.cal-wrap{ background: rgba(255,255,255,0.06); border-radius:16px; padding:12px; }
.cal-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
.cal-title{ font-weight:800; letter-spacing:0.2px; }
.cal-nav{ display:flex; gap:8px; }
.cal-btn{ padding:8px 10px; border:0; border-radius:12px; background: rgba(255,255,255,0.10); color:#fff; cursor:pointer; }
.cal-grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
.cal-dow{ font-size:0.78rem; opacity:0.75; text-align:center; padding:4px 0; }
.cal-cell{ position:relative; min-height:44px; border-radius:12px; background: rgba(0,0,0,0.18); display:flex; align-items:flex-start; justify-content:flex-start; padding:8px; }
.cal-cell.muted{ opacity:0.35; }
.cal-day{ font-weight:700; font-size:0.92rem; }
.cal-mark{ position:absolute; right:8px; bottom:6px; font-size:0.78rem; padding:2px 7px; border-radius:999px; background: rgba(79,195,247,0.22); border:1px solid rgba(79,195,247,0.45); }
.cal-mark.first{ opacity:0.6; }
.cal-mark.good{ background: rgba(76,175,80,0.22); border-color: rgba(76,175,80,0.55); }
.cal-mark.early{ background: rgba(255,235,59,0.22); border-color: rgba(255,235,59,0.60); }
.cal-mark.late{ background: rgba(255,152,0,0.22); border-color: rgba(255,152,0,0.60); }
.cal-mark.verylate{ background: rgba(244,67,54,0.18); border-color: rgba(244,67,54,0.60); }
.cal-legend{ margin-top:10px; font-size:0.9rem; opacity:0.85; }


/* ===== index_style_option2_radical overrides ===== */
/* === Visual novo (premium dark) === */
:root{
  --bg0:#070b12;
  --bg1:#0b1220;
  --card:#101a2f;
  --card2:#0c1426;
  --stroke: rgba(255,255,255,.08);
  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.78);
  --accent:#38bdf8;
  --radius:18px;
}

html, body{
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif !important;
  background: radial-gradient(1200px 900px at 20% 0%, #0b2b3a 0%, transparent 55%),
              radial-gradient(1100px 900px at 90% 10%, #1b2a66 0%, transparent 55%),
              linear-gradient(180deg, var(--bg1), var(--bg0)) !important;
  color: var(--text) !important;
}

/* Cabe√ßalho / barras */
.topbar, header, .header{
  background: transparent !important;
  box-shadow: none !important;
}

/* Bot√µes: flat + accent */
button, .btn{
  background: linear-gradient(180deg, rgba(56,189,248,.95), rgba(56,189,248,.78)) !important;
  color: #041018 !important;
  border: none !important;
  border-radius: 14px !important;
  padding: 10px 12px !important;
  font-weight: 700 !important;
  font-size: 18px !important;
}
button.secundario, .btn.secundario{
  background: transparent !important;
  color: var(--text) !important;
  box-shadow: inset 0 0 0 1px var(--stroke) !important;
  font-weight: 600 !important;
}

/* Cards: dark flat com borda sutil */
.card{
  background: linear-gradient(180deg, rgba(16,26,47,.92), rgba(12,20,38,.92)) !important;
  border: 1px solid var(--stroke) !important;
  border-left: 1px solid var(--stroke) !important;
  border-radius: var(--radius) !important;
  padding: 14px !important;
  box-shadow: 0 10px 28px rgba(0,0,0,.35) !important;
  backdrop-filter: blur(6px);
}
.card:hover{ transform: translateY(-2px) !important; box-shadow: 0 14px 34px rgba(0,0,0,.42) !important; }

/* Status: sem ‚Äúmoldura‚Äù forte, s√≥ um brilho discreto */
.card.ok{ box-shadow: 0 10px 28px rgba(0,0,0,.35), 0 0 0 1px rgba(34,197,94,.12) inset !important; }
.card.alerta{ box-shadow: 0 10px 28px rgba(0,0,0,.35), 0 0 0 1px rgba(245,158,11,.16) inset !important; }
.card.critico{ box-shadow: 0 10px 28px rgba(0,0,0,.35), 0 0 0 1px rgba(239,68,68,.18) inset !important; }
.card.neutro{ box-shadow: 0 10px 28px rgba(0,0,0,.35), 0 0 0 1px rgba(148,163,184,.12) inset !important; }
.card.ok, .card.alerta, .card.critico, .card.neutro{ border-left-width: 0 !important; }

/* Tipografia do card */
.card-title{ font-size: 24px !important; font-weight: 700 !important; letter-spacing: .2px; color: var(--text) !important; }
.card-icon{ font-size: 28px !important; opacity: .95 !important; }
.card-days{ font-size: 34px !important; font-weight: 800 !important; }
.card-days span{ font-size: 20px !important; color: var(--muted) !important; }
.card-ideal{ font-size: 20px !important; color: var(--muted) !important; }

/* Modal: glass */
.modal{
  background: rgba(0,0,0,.55) !important;
  backdrop-filter: blur(6px);
}
.modal > div{
  background: linear-gradient(180deg, rgba(16,26,47,.96), rgba(12,20,38,.96)) !important;
  border: 1px solid var(--stroke) !important;
  border-radius: 18px !important;
  padding: 18px !important;
  box-shadow: 0 24px 60px rgba(0,0,0,.55) !important;
}

/* Inputs: dark clean */
input, textarea, select{
  background: rgba(255,255,255,.06) !important;
  color: var(--text) !important;
  border: 1px solid var(--stroke) !important;
  border-radius: 14px !important;
  padding: 12px 12px !important;
  font-size: 16px !important;
}
input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.55) !important; }

/* Tabs: pills clean */
.tabs .tab{
  background: rgba(255,255,255,.05) !important;
  border: 1px solid var(--stroke) !important;
  color: var(--muted) !important;
  border-radius: 999px !important;
  padding: 10px 12px !important;
  font-size: 13px !important;
}
.tabs .tab.active{
  background: rgba(56,189,248,.18) !important;
  border-color: rgba(56,189,248,.28) !important;
  color: var(--text) !important;
}

/* Icon buttons */
.icon-btn{
  width: 34px !important;
  height: 34px !important;
  font-size: 16px !important;
  background: rgba(255,255,255,.06) !important;
  border: 1px solid var(--stroke) !important;
  color: var(--text) !important;
  border-radius: 12px !important;
}

/* Chips/toggles */
.chip, .toggle-chip, .evt-chip{
  background: rgba(255,255,255,.06) !important;
  border: 1px solid var(--stroke) !important;
  color: var(--text) !important;
  border-radius: 999px !important;
  padding: 8px 10px !important;
  font-size: 12px !important;
}
.chip.active, .toggle-chip.active, .evt-chip.active{
  background: rgba(56,189,248,.18) !important;
  border-color: rgba(56,189,248,.30) !important;
}

/* Calend√°rio: mais elegante */
.cal-day{
  background: rgba(255,255,255,.04) !important;
  border: 1px solid rgba(255,255,255,.06) !important;
  border-radius: 14px !important;
}

/* ---- Cards Manage (V1) ---- */
.modal-box.wide{max-width: 980px;}
.cards-manage-list{display:flex;flex-direction:column;gap:10px;margin:12px 0;max-height:60vh;overflow:auto;padding-right:6px;}
.cards-manage-row{display:flex;gap:10px;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:10px;}
.cm-left{display:flex;gap:10px;align-items:center;flex:1;min-width:0;}
.cm-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
.cm-ico{width:56px;text-align:center;font-size:20px;}
.cm-name{flex:1;min-width:120px;}
.cm-key{font-size:12px;opacity:.6;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.cm-num{width:140px;max-width:42vw;}
.btn.small{padding:8px 10px;font-size:14px;border-radius:12px;}
.btn.small.ghost{opacity:.75;}
@media (max-width: 600px){
  .modal-box.wide{max-width: 96vw;}
  .cards-manage-row{flex-direction:column;align-items:stretch;}
  .cm-right{justify-content:flex-start;}
  .cm-num{width:100%;max-width:none;}
  .cm-key{max-width:none;}
}

</style>
</head>

<body>

<div class="topbar">
  <div class="app-title">üê† Aqu√°rio</div>
  <button class="config-btn" onclick="abrirConfig()">‚öôÔ∏è</button>
</div>


<button onclick="abrirConfig()">‚öôÔ∏è Configura√ß√µes</button>

<button onclick="abrirAnalytics()">üìä Analytics</button>
<button onclick="abrirGerenciarCards()">üß© Cards</button>

<div id="cards"></div>

<!-- MODAL GERENCIAR CARDS -->
<div id="modalCards" class="modal">
  <div class="modal-box wide">
    <div class="modal-head">
      <h3>Gerenciar Cards</h3>
      <button class="btn-ghost" onclick="fecharModalCards()">‚úï</button>
    </div>

    <div class="help">
      <small>Reordene (‚Üë/‚Üì), oculte/mostre, edite nome/√≠cone e ajuste Ideal/Intervalo. Ocultar n√£o apaga o hist√≥rico.</small>
    </div>

    <div id="listaCardsManage" class="cards-manage-list"></div>

    <div class="row">
      <button class="btn" onclick="adicionarNovoCard()">‚ûï Adicionar card</button>
      <button class="btn primary" onclick="salvarCardsManage()">Salvar</button>
    </div>
  </div>
</div>

<!-- MODAL MEDI√á√ÉO -->
<div id="modal" class="modal">
  <div>
    <h3 id="titulo"></h3>
    <input type="date" id="data">
    <input type="number" step="any" id="valor" placeholder="Valor">
    <textarea id="obs" placeholder="Observa√ß√µes"></textarea>
    <button class="btn-primary" onclick="salvar()">Salvar</button>
    <button class="btn-secondary" onclick="abrirHistorico()">üìú Hist√≥rico</button><br><br>
    <button class="secundario" onclick="fechar()">Cancelar</button>
  </div>
</div>

<!-- MODAL HIST√ìRICO -->
<div id="historicoModal" class="modal">
  <div class="modal-content modal-historico">
    <div class="hist-header">
      <h3 id="histTitulo" style="margin:0;"></h3>
      <button class="icon-btn" onclick="fecharHistorico()" aria-label="Fechar">‚úï</button>
    </div>

    <div class="hist-tabs" role="tablist" aria-label="Abas do hist√≥rico">
      <button class="tab-btn active" data-tab="registros" role="tab" aria-selected="true">Registros</button>
      <button class="tab-btn" data-tab="grafico" role="tab" aria-selected="false">Gr√°fico</button>
      <button class="tab-btn" data-tab="calendario" role="tab" aria-selected="false" style="display:none;">Calend√°rio</button>
      <button class="tab-btn" data-tab="insights" role="tab" aria-selected="false">Insights</button>
    </div>

    <div class="hist-body">
      <!-- TAB: REGISTROS -->
      <div class="tab-panel active" id="tab-registros" role="tabpanel">
        <div id="histResumoRegistros" class="muted" style="margin:6px 2px 10px;"></div>
        <div id="listaHistorico" class="hist-list"></div>
        <button id="btnMaisHist" class="secundario full-width" style="display:none; margin-top:10px;">Carregar mais</button>
      </div>

      <!-- TAB: GR√ÅFICO -->
      <div class="tab-panel" id="tab-grafico" role="tabpanel">
      <div class="toggle-chips" style="margin:8px 0 10px;">
        <label class="chip">
          <input type="checkbox" id="chkUltimosDias">
          <span>√öltimos</span>
        </label>
        <label class="chip" style="gap:10px;">
          <span style="opacity:0.9;">Per√≠odo</span>
          <select id="selUltimosDias" style="background:transparent; color:#fff; border:0; font-weight:700; outline:none;">
            <option value="7">7d</option>
            <option value="30">30d</option>
            <option value="60">60d</option>
            <option value="90">90d</option>
          </select>
        </label>
      </div>

        <div id="eventChips" class="toggle-chips" style="margin:8px 0 10px;"></div>
        <div class="toggle-chips" style="margin:0 0 10px;">
          <label class="chip">
            <input type="checkbox" id="chkMA7">
            <span>M√©dia 7 dias</span>
          </label>
          <label class="chip" id="chipIdeal">
            <input type="checkbox" id="chkIdeal">
            <span>Linha ideal</span>
          </label>
        </div>
        <canvas id="grafico" class="hist-chart"></canvas>
      </div>


      <!-- TAB: CALEND√ÅRIO -->
      <div class="tab-panel" id="tab-calendario" role="tabpanel">
        <div class="cal-wrap">
          <div class="cal-header">
            <div class="cal-title" id="calTitle"></div>
            <div class="cal-nav">
              <button class="cal-btn" id="calPrev" type="button">‚óÄ</button>
              <button class="cal-btn" id="calHoje" type="button">Hoje</button>
              <button class="cal-btn" id="calNext" type="button">‚ñ∂</button>
            </div>
          </div>
          <div class="cal-grid" id="calGrid"></div>
          <div class="cal-legend muted" id="calLegend"></div>
        </div>
      </div>

<!-- TAB: INSIGHTS -->
      <div class="tab-panel" id="tab-insights" role="tabpanel">
        <div id="histKpi" class="kpi-row"></div>
        <div class="muted" style="margin-top:10px; line-height:1.4;">
          Dica: use as linhas de TPA para entender se o par√¢metro melhora (ou piora) ap√≥s as trocas de √°gua.
        </div>
      </div>
    </div>

  </div>
</div>


<!-- MODAL ANALYTICS -->
<div id="analyticsModal" class="modal">
  <div class="modal-content">
    <h3>üìä Aquarismo Analytics</h3>

    <div id="analyticsCards" class="analytics-grid"></div>

    <div class="analytics-card">
      <h4>üìå Pend√™ncias (por intervalo)</h4>
      <div id="analyticsPendencias"></div>
    </div>

    <div class="analytics-card">
      <h4>üéØ Desvio do ideal (√∫ltimo valor)</h4>
      <div id="analyticsDesvios"></div>
    </div>

    <div class="modal-botoes">
      <button class="secundario" onclick="fecharAnalytics()">Fechar</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIG -->
<div id="configModal" class="modal">
  <div class="modal-content">
    <h3>‚öôÔ∏è Configura√ß√µes</h3>

    <div class="config-scroll">
      <div id="configCampos" class="config-grid"></div>
    </div>
<div class="config-backup">
  <button class="btn-backup" onclick="exportarDados()">üì§ Exportar Backup</button>

  <input type="file" id="importFile" accept=".json" hidden onchange="importarDados(this.files[0])">

  <button class="btn-backup" onclick="document.getElementById('importFile').click()">
    üì• Importar Backup
  </button>
</div>

    <div class="modal-botoes">
      <button onclick="salvarConfig()">Salvar</button>
      <button class="secundario" onclick="fecharConfig()">Cancelar</button>
    </div>
  </div>
</div>

<div id="confirmModal" class="modal">
  <div class="modal-box">
    <h3>Excluir registro?</h3>
    <p>Esta a√ß√£o n√£o poder√° ser desfeita.</p>
    <div class="modal-actions">
      <button class="btn cancel" onclick="fecharConfirm()">Cancelar</button>
      <button class="btn danger" onclick="confirmarExclusao()">Excluir</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

<script>
// ------------------- ITENS -------------------
let itens = [
  "Densidade","KH","Fosfato","pH",
  "Nitrito","Am√¥nia","TPA", "Perlon","Phosgard","Aquapure",
  "Fuel","Carbonate","BioActive","Stability","ZooPlancton","PhytoPlancton"
];

const icones = {
  TPA: "üíß",
  Densidade: "‚öñÔ∏è",
  KH: "üß™",
  Fosfato: "üß´",
  pH: "üåä",
  Nitrito: "‚ò†Ô∏è",
  Am√¥nia: "‚ò¢Ô∏è",
  Perlon: "üßª",
  Phosgard: "üß±",
  Aquapure: "üîµ",
  Fuel: "üî•",
  Carbonate: "ü™®",
  BioActive: "ü¶†",
  Stability: "‚öì",
  ZooPlancton: "ü¶ê",
  PhytoPlancton: "üß¨"
};
// ------------------- CARDS EDIT√ÅVEIS (V1) -------------------
// Mant√©m compatibilidade: hist√≥ricos continuam em localStorage por chave (ex: "KH", "TPA").
// "cardsConfig" guarda apenas metadados (ordem/ativo/label/icone) e par√¢metros (ideal/dias).

const CARDS_DEFAULT = itens.map((k, i) => ({
  key: k,
  label: k,
  icon: icones[k] || "üß©",
  ordem: i + 1,
  ativo: true
}));

function loadCardsConfig(){
  let cfg = null;
  try {
    cfg = JSON.parse(localStorage.getItem("cardsConfig") || "null");
  } catch (e) {
    console.warn("cardsConfig inv√°lido. Resetando.", e);
    cfg = null;
  }
  if (!Array.isArray(cfg)) {
    // primeira vez
    localStorage.setItem("cardsConfig", JSON.stringify(CARDS_DEFAULT));
    cfg = CARDS_DEFAULT.slice();
  }

  // migrar: garantir que todos os defaults existam
  const byKey = new Map(cfg.map(c => [c.key, c]));
  CARDS_DEFAULT.forEach(d => {
    if (!byKey.has(d.key)) cfg.push(d);
  });

  // normalizar campos
  cfg.forEach((c, idx) => {
    c.key = String(c.key || "").trim() || ("Card" + idx);
    c.label = (c.label ?? c.key).toString();
    c.icon = (c.icon ?? icones[c.key] ?? "üß©").toString();
    c.ordem = Number.isFinite(+c.ordem) ? +c.ordem : (idx + 1);
    c.ativo = (c.ativo !== false);
    // manter ideal/dias dentro do cardsConfig para novos cards
    if (c.ideal === undefined) c.ideal = null;
    if (c.dias === undefined) c.dias = null;
    if (!c.tipo) c.tipo = null; // opcional
  });

  localStorage.setItem("cardsConfig", JSON.stringify(cfg));

  // manter a lista global 'itens' sincronizada (inclui ocultos, para config/hist√≥rico n√£o quebrar)
  itens = cfg.map(c => c.key);

  // garantir configPadrao para novos cards (sem quebrar carregarConfig)
  cfg.forEach(c => {
    if (!configPadrao[c.key]) {
      configPadrao[c.key] = { dias: c.dias ?? null, ideal: c.ideal ?? null };
    }
  });

  // garantir que 'config' inclua os novos cards (sem apagar o dos usu√°rios)
  try {
    const raw = localStorage.getItem("config");
    const saved = raw ? JSON.parse(raw) : {};
    let changed = false;
    cfg.forEach(c => {
      if (!saved[c.key]) {
        saved[c.key] = {
          dias: (c.dias ?? configPadrao[c.key]?.dias ?? null),
          ideal: (c.ideal ?? configPadrao[c.key]?.ideal ?? null)
        };
        changed = true;
      }
    });
    if (changed) localStorage.setItem("config", JSON.stringify(saved));
  } catch (e) {
    // deixa carregarConfig lidar com isso
  }

  return cfg;
}

function saveCardsConfig(cfg){
  localStorage.setItem("cardsConfig", JSON.stringify(cfg));
  // ressincroniza itens e defaults
  loadCardsConfig();
}

function getCardMeta(key){
  const cfg = loadCardsConfig();
  const c = cfg.find(x => x.key === key);
  return c || { key, label: key, icon: icones[key] || "üß©", ativo: true, ordem: 999, ideal: null, dias: null };
}

function getCardsAtivosOrdenados(){
  const cfg = loadCardsConfig();
  return cfg.filter(c => c.ativo).sort((a,b)=>a.ordem-b.ordem);
}

// ------------------- UI: GERENCIAR CARDS -------------------
let _cardsDraft = null;

function abrirGerenciarCards(){
  fecharTodosModais();
  const modal = document.getElementById("modalCards");
  modal.style.display = "flex";
  _cardsDraft = loadCardsConfig().slice().sort((a,b)=>a.ordem-b.ordem);
  renderListaCardsManage();
}

function fecharModalCards(){
  document.getElementById("modalCards").style.display = "none";
  _cardsDraft = null;
}

function renderListaCardsManage(){
  const el = document.getElementById("listaCardsManage");
  if (!el) return;
  el.innerHTML = "";
  (_cardsDraft || []).sort((a,b)=>a.ordem-b.ordem).forEach((c, idx) => {
    const row = document.createElement("div");
    row.className = "cards-manage-row";
    row.innerHTML = `
      <div class="cm-left">
        <input class="cm-ico" maxlength="3" value="${escapeHtml(c.icon || "üß©")}" title="√çcone (emoji)" />
        <input class="cm-name" value="${escapeHtml(c.label || c.key)}" title="Nome do card" />
        <span class="cm-key" title="Chave interna (hist√≥rico)">${escapeHtml(c.key)}</span>
      </div>

      <div class="cm-right">
        <input class="cm-num" type="number" step="any" placeholder="Ideal" value="${c.ideal ?? ""}" title="Valor ideal (opcional)" />
        <input class="cm-num" type="number" step="1" placeholder="Intervalo (dias)" value="${c.dias ?? ""}" title="Intervalo ideal em dias (opcional)" />
        <button class="btn small" title="Subir" data-act="up">‚Üë</button>
        <button class="btn small" title="Descer" data-act="down">‚Üì</button>
        <button class="btn small ${c.ativo? '' : 'ghost'}" title="${c.ativo?'Ocultar':'Mostrar'}" data-act="toggle">${c.ativo?'Ocultar':'Mostrar'}</button>
      </div>
    `;

    // handlers
    const [inpIco, inpName] = row.querySelectorAll("input.cm-ico, input.cm-name");
    const nums = row.querySelectorAll("input.cm-num");
    inpIco.addEventListener("input", e => { c.icon = e.target.value; });
    inpName.addEventListener("input", e => { c.label = e.target.value; });

    nums[0].addEventListener("input", e => { c.ideal = e.target.value === "" ? null : Number(e.target.value); });
    nums[1].addEventListener("input", e => { c.dias = e.target.value === "" ? null : Number(e.target.value); });

    row.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const act = btn.getAttribute("data-act");
        if (act === "toggle") c.ativo = !c.ativo;
        if (act === "up") swapOrder(idx, idx-1);
        if (act === "down") swapOrder(idx, idx+1);
        renderListaCardsManage();
      });
    });

    el.appendChild(row);
  });
}

function swapOrder(i, j){
  if (!_cardsDraft) return;
  const arr = _cardsDraft.sort((a,b)=>a.ordem-b.ordem);
  if (j < 0 || j >= arr.length) return;
  const a = arr[i], b = arr[j];
  const tmp = a.ordem;
  a.ordem = b.ordem;
  b.ordem = tmp;
}

function adicionarNovoCard(){
  if (!_cardsDraft) _cardsDraft = loadCardsConfig().slice();
  const base = "Novo";
  let key = base;
  let n = 1;
  const keys = new Set(_cardsDraft.map(x=>x.key));
  while (keys.has(key)) { n++; key = base + n; }
  const ordemMax = Math.max(0, ..._cardsDraft.map(x=>+x.ordem||0));
  _cardsDraft.push({
    key,
    label: key,
    icon: "üß©",
    ordem: ordemMax + 1,
    ativo: true,
    ideal: null,
    dias: null,
    tipo: null
  });
  renderListaCardsManage();
}

function salvarCardsManage(){
  if (!_cardsDraft) { fecharModalCards(); return; }

  // salvar cardsConfig
  saveCardsConfig(_cardsDraft);

  // aplicar ideal/dias no config (compatibilidade com o resto do app)
  let cfgSaved = {};
  try {
    cfgSaved = JSON.parse(localStorage.getItem("config")||"{}");
  } catch(e) { cfgSaved = {}; }

  _cardsDraft.forEach(c=>{
    if (!cfgSaved[c.key]) cfgSaved[c.key] = { dias: null, ideal: null };
    if (c.dias !== undefined) cfgSaved[c.key].dias = c.dias;
    if (c.ideal !== undefined) cfgSaved[c.key].ideal = c.ideal;
    if (!configPadrao[c.key]) configPadrao[c.key] = { dias: c.dias ?? null, ideal: c.ideal ?? null };
  });

  localStorage.setItem("config", JSON.stringify(cfgSaved));

  fecharModalCards();
  carregar(); // redesenha cards na tela inicial
}

// util
function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}


const statusIcone = {
  ok: "OK",
  alerta: "ATEN√á√ÉO",
  critico: "URGENTE",
  neutro: "‚Äî"
};


// ------------------- CONFIG -------------------
const configPadrao = {
  TPA:{dias:10, ideal:null},
  Densidade:{dias:7, ideal:1.025},
  KH:{dias:3, ideal:8},
  Fosfato:{dias:7, ideal:0.03},
  pH:{dias:3, ideal:8.2},
  Nitrito:{dias:7, ideal:0},
  Am√¥nia:{dias:7, ideal:0},
  Perlon:{dias:15, ideal:null},
  Phosgard:{dias:30, ideal:null},
  Aquapure:{dias:30, ideal:null},
  Fuel:{dias:null, ideal:null},
  Carbonate:{dias:null, ideal:null},
  BioActive:{dias:null, ideal:null},
  Stability:{dias:null, ideal:null},
  ZooPlancton:{dias:null, ideal:null},
  PhytoPlancton:{dias:null, ideal:null}
};

function carregarConfig(){
  loadCardsConfig();
  // Config pode corromper (ex.: edi√ß√£o manual no storage). N√£o deixe isso quebrar o app.
  let cfgSalvo = {};
  try {
    const raw = localStorage.getItem("config");
    cfgSalvo = raw ? JSON.parse(raw) : {};
  } catch (e) {
    console.warn("Config inv√°lida no localStorage (chave 'config'). Resetando.", e);
    cfgSalvo = {};
  }

  const cfgFinal = {};
  itens.forEach(nome => {
    cfgFinal[nome] = {
      dias: cfgSalvo?.[nome]?.dias ?? configPadrao[nome].dias,
      ideal: cfgSalvo?.[nome]?.ideal ?? configPadrao[nome].ideal
    };
  });

  localStorage.setItem("config", JSON.stringify(cfgFinal));
  return cfgFinal;
}



// ------------------- ANALYTICS (gr√°ficos e influ√™ncias) -------------------
const ANALYTICS_CONFIG = {
  // Par√¢metros com gr√°fico
  Densidade: { grafico: true, eventos: ["TPA"] },
  KH:        { grafico: true, eventos: ["TPA", "Carbonate"] },
  Fosfato:   { grafico: true, eventos: ["TPA", "Phosgard"] },
  pH:        { grafico: true, eventos: ["TPA"] },
  Nitrito:   { grafico: true, eventos: ["TPA", "Bacterias", "Perlon"] },
  Am√¥nia:    { grafico: true, eventos: ["TPA", "Bacterias", "Perlon"] },
  Carbonate: { grafico: true, eventos: ["TPA"] },

  // Itens sem gr√°fico (apenas registros)
  TPA:          { grafico: false },
  Perlon:       { grafico: false },
  Phosgard:     { grafico: false },
  Aquapure:     { grafico: false },
  Fuel:         { grafico: false },
  BioActive:    { grafico: false },
  Stability:    { grafico: false },
  ZooPlancton:  { grafico: false },
  PhytoPlancton:{ grafico: false }
};

// Agrupamentos de eventos (um checkbox representa v√°rios registros)
const EVENT_GROUPS = {
  Bacterias: ["BioActive", "Stability"]
};

const EVENT_LABELS = {
  TPA: "TPA",
  Carbonate: "Carbonate",
  Phosgard: "Phosgard",
  Perlon: "Perlon",
  Bacterias: "Bact√©rias"
};

function itemTemGrafico(nome){
  return ANALYTICS_CONFIG?.[nome]?.grafico === true;
}

function eventosDoGrafico(nome){
  return ANALYTICS_CONFIG?.[nome]?.eventos || [];
}

// Persist√™ncia dos toggles por item
function _getEventState(){
  return JSON.parse(localStorage.getItem("eventToggles") || "{}");
}
function _setEventState(obj){
  localStorage.setItem("eventToggles", JSON.stringify(obj));
}
function getEventoAtivo(item, evento){
  const st = _getEventState();
  const key = item + "::" + evento;
  // padr√£o: ligado
  return st[key] ?? true;
}
function setEventoAtivo(item, evento, val){
  const st = _getEventState();
  const key = item + "::" + evento;
  st[key] = !!val;
  _setEventState(st);
}

function getChipTexto(evento){
  return EVENT_LABELS[evento] || evento;
}

function obterTimestampsEvento(evento){
  const fontes = EVENT_GROUPS[evento] || [evento];
  let xs = [];
  for (const nome of fontes){
    const arr = JSON.parse(localStorage.getItem(nome) || "[]");
    for (const r of arr){
      if (r?.data){
        const t = new Date(r.data).getTime();
        if (Number.isFinite(t)) xs.push(t);
      }
    }
  }
  // √∫nicos + ordenados
  xs = Array.from(new Set(xs)).sort((a,b)=>a-b);
  return xs;
}

// ------------------- UTIL -------------------
function diasDesde(dataStr){
  if(!dataStr) return "Nunca";
  const hoje = new Date();
  const data = new Date(dataStr);
  const diff = hoje - data;
  const dias = Math.floor(diff / (1000*60*60*24));
  if(dias===0) return "Hoje";
  if(dias===1) return "1 dia";
  return dias+" dias";
}

function diasNumero(dataStr){
  if(!dataStr) return null;
  const hoje = new Date();
  const data = new Date(dataStr);
  const diff = hoje - data;
  const dias = Math.floor(diff / (1000*60*60*24));
  return Number.isFinite(dias) ? dias : null;
}

function classeAlerta(diasStr, limite){
  // Sem intervalo definido ‚Üí sempre neutro
  if (limite === null || isNaN(limite)) return "neutro";

  if(diasStr==="Nunca") return "neutro";
  if(diasStr==="Hoje") return "ok";

  const dias = parseInt(diasStr);
  if(isNaN(dias)) return "neutro";

  if(dias < limite*0.8) return "ok";
  if(dias <= limite) return "alerta";
  return "critico";
}


// ------------------- TELA PRINCIPAL -------------------
function carregar(){
  const cards = document.getElementById("cards");
  loadCardsConfig();
  const cfg = carregarConfig();
  cards.innerHTML = "";

  getCardsAtivosOrdenados().forEach(card=>{
    const nome = card.key;
    const label = card.label || nome;
    const icon = card.icon || icones[nome] || "üê†";

    const hist = JSON.parse(localStorage.getItem(nome)||"[]");
    const temHistorico = hist.length > 0;
    const ultimaData = obterUltimaData(hist);
    const diasStr = diasDesde(ultimaData);
    const diasNum = diasNumero(ultimaData);
    const limite = cfg[nome].dias;
    const classe = classeAlerta(diasStr, limite);

    let statusTxt = statusIcone[classe];
    if (classe === "critico" && typeof limite === "number" && !isNaN(limite) && diasNum !== null) {
      const atraso = Math.max(1, diasNum - limite);
      statusTxt = `URGENTE +${atraso}d`;
    }

    const div = document.createElement("div");
    div.className = "card "+classe;
    div.innerHTML = `
      <div class="card-header">
        <div class="card-icon">${icon}</div>
        <div class="card-title">${label}</div>
      </div>

      <div class="card-days">
        ${
          !temHistorico
            ? "‚Äî<span>sem dados</span>"
            : diasStr === "Hoje"
              ? "Hoje"
              : diasStr === "1 dia"
                ? "1<span>dia</span>"
                : `${diasStr.replace(" dias","")}<span> dias</span>`
        }
      </div>


      <div class="card-ideal">
        ${limite ? `Ideal: ${limite} dias` : "Sem intervalo"}
      </div>
      <div class="card-status">${statusTxt}</div>

    `;
    div.onclick = ()=>abrir(nome);
    cards.appendChild(div);
  });
}

// ------------------- MEDI√á√ïES -------------------
let atual = null;
let indiceEdicao = null;
let excluirItem = null;
let excluirId = null;


function abrir(nome){
  if (!nome) return;
  fecharTodosModais();   // ‚Üê ADICIONAR
  atual = nome;
  indiceEdicao = null;
  document.getElementById("titulo").innerText = (getCardMeta(nome).label || nome);
  const hoje = new Date().toISOString().split("T")[0];
  document.getElementById("data").value = hoje;
  // Prefill: se houver valor ideal configurado, j√° sugerir esse valor
  const cfg = carregarConfig();
  const ideal = cfg?.[nome]?.ideal;
  // Prefill: ideal; se n√£o houver ideal, usar o √∫ltimo valor registrado (se existir)
  const hist = JSON.parse(localStorage.getItem(nome)||"[]");
  const ultimoValor = hist.length ? (hist[0].valor ?? hist[hist.length-1].valor) : "";
  document.getElementById("valor").value =
    (ideal !== null && ideal !== undefined && ideal !== "") ? ideal :
    (ultimoValor !== null && ultimoValor !== undefined && ultimoValor !== "") ? ultimoValor : "";
  document.getElementById("obs").value = "";
  document.getElementById("modal").style.display = "flex";
}


function fechar(){
  document.getElementById("modal").style.display="none";
}

function salvar() {
  let hist = JSON.parse(localStorage.getItem(atual) || "[]");

  const novo = {
    id: indiceEdicao || crypto.randomUUID(),
    data: document.getElementById("data").value,
    valor: document.getElementById("valor").value,
    obs: document.getElementById("obs").value
  };

  if (indiceEdicao) {
    hist = hist.map(r => r.id === indiceEdicao ? novo : r);
    indiceEdicao = null;
  } else {
    hist.push(novo);
  }

  localStorage.setItem(atual, JSON.stringify(hist));
  normalizarHistorico(atual);

  fechar();
  carregar();
}

// ------------------- HIST√ìRICO -------------------
let _histCache = [];
let _histMostrando = 0;
const HIST_PAGE_SIZE = 30;

function setTabHistorico(tab) {
  const btns = document.querySelectorAll("#historicoModal .tab-btn");
  const panels = document.querySelectorAll("#historicoModal .tab-panel");
  btns.forEach(b => {
    const active = b.dataset.tab === tab;
    b.classList.toggle("active", active);
    b.setAttribute("aria-selected", active ? "true" : "false");
  });
  panels.forEach(p => p.classList.toggle("active", p.id === "tab-" + tab));

  // Redesenha quando entrar no gr√°fico (canvas em tabs √†s vezes calcula tamanho errado)
  if (tab === "grafico" && typeof atual === "string") {
    setTimeout(() => desenharGrafico(atual), 50);
  }

  // Re-render do calend√°rio quando entrar (para ficar sempre consistente)
  if (tab === "calendario" && typeof atual === "string") {
    setTimeout(() => renderCalendario(atual), 10);
  }
}

function ajustarAbasHistorico(temGrafico){
  const btnGraf = document.querySelector('#historicoModal .tab-btn[data-tab="grafico"]');
  const btnCal = document.querySelector('#historicoModal .tab-btn[data-tab="calendario"]');
  const btnIns = document.querySelector('#historicoModal .tab-btn[data-tab="insights"]');

  const pnlGraf = document.getElementById('tab-grafico');
  const pnlCal  = document.getElementById('tab-calendario');
  const pnlIns  = document.getElementById('tab-insights');

  if (temGrafico) {
    // Mostra Gr√°fico/Insights; esconde Calend√°rio
    if (btnGraf) btnGraf.style.display = "";
    if (btnIns)  btnIns.style.display  = "";
    if (pnlGraf) pnlGraf.style.display = "";
    if (pnlIns)  pnlIns.style.display  = "";

    if (btnCal) btnCal.style.display = "none";
    if (pnlCal) pnlCal.style.display = "none";
  } else {
    // Mostra Calend√°rio; esconde Gr√°fico/Insights
    if (btnGraf) btnGraf.style.display = "none";
    if (btnIns)  btnIns.style.display  = "none";
    if (pnlGraf) pnlGraf.style.display = "none";
    if (pnlIns)  pnlIns.style.display  = "none";

    if (btnCal) btnCal.style.display = "";
    if (pnlCal) pnlCal.style.display = "";

    setTabHistorico("registros");
  }
}

function renderEventChips(item){
  const box = document.getElementById("eventChips");
  if (!box) return;
  box.innerHTML = "";

  const eventos = eventosDoGrafico(item);
  for (const ev of eventos){
    const id = "chkEvt_" + ev;
    const label = document.createElement("label");
    label.className = "chip";
    label.innerHTML = `<input type="checkbox" id="${id}"><span>${getChipTexto(ev)}</span>`;
    box.appendChild(label);

    const input = label.querySelector("input");
    input.checked = getEventoAtivo(item, ev);
    input.onchange = () => { setEventoAtivo(item, ev, input.checked); desenharGrafico(item); };
  }
}



function renderHistoricoLista() {
  const lista = document.getElementById("listaHistorico");
  const resumo = document.getElementById("histResumoRegistros");
  const btnMais = document.getElementById("btnMaisHist");

  const total = _histCache.length;
  const mostrar = Math.min(_histMostrando, total);

  lista.innerHTML = "";
  for (let i = 0; i < mostrar; i++) {
    const item = _histCache[i];

    const dataTxt = item.data || "";
    const valorTxt = (item.valor !== undefined && item.valor !== null) ? item.valor : "";
    const obsTxt = (item.obs || "").trim();

    lista.innerHTML += `
      <div class="hist-item">
        <div class="hist-left">
          <div class="hist-date">${dataTxt}</div>
          <div class="hist-value">${valorTxt}</div>
          ${obsTxt ? `<div class="hist-obs">${obsTxt}</div>` : ``}
        </div>
        <div class="hist-actions">
          <button class="icon-btn" onclick="editarMedicao('${item.id}')" aria-label="Editar">‚úèÔ∏è</button>
          <button class="icon-btn danger" onclick="pedirExclusao('${atual}','${item.id}')" aria-label="Excluir">üóëÔ∏è</button>
        </div>
      </div>
    `;
  }

  if (resumo) resumo.innerText = `Mostrando ${mostrar} de ${total} registro(s).`;

  if (btnMais) {
    const temMais = mostrar < total;
    btnMais.style.display = temMais ? "block" : "none";
    btnMais.onclick = () => {
      _histMostrando = Math.min(_histMostrando + HIST_PAGE_SIZE, total);
      renderHistoricoLista();
    };
  }
}

function abrirHistorico() {
  if (!atual) return;

  fecharTodosModais();

  document.getElementById("histTitulo").innerText = (getCardMeta(atual).label || atual);

  // üîë SEMPRE normaliza antes
  const hist = normalizarHistorico(atual).slice().reverse();

  _histCache = hist;           // j√° est√° do mais novo pro mais antigo
  _histMostrando = Math.min(HIST_PAGE_SIZE, _histCache.length);
  renderHistoricoLista();

  // Tabs: sempre come√ßa em Registros
  setTabHistorico("registros");

  // Ajusta abas conforme item ter (ou n√£o) gr√°fico
  const temGrafico = itemTemGrafico(atual);
  ajustarAbasHistorico(temGrafico);

  // Chips de eventos (TPA / Carbonate / etc.) ‚Äì gerados dinamicamente
  renderEventChips(atual);



  // Gr√°fico/KPIs apenas quando aplic√°vel
  if (temGrafico) {
    // mostra/oculta chip ideal conforme existir ideal num√©rico
    const cfg = carregarConfig();
    const ideal = cfg?.[atual]?.ideal;
    const chipIdeal = document.getElementById('chipIdeal');
    if (chipIdeal) chipIdeal.style.display = (typeof ideal === 'number' && Number.isFinite(ideal)) ? '' : 'none';

    // Inicializa toggles do gr√°fico (M√©dia 7d / Ideal / Filtro √∫ltimos X dias)
    const chkMA7 = document.getElementById('chkMA7');
    if (chkMA7) {
      chkMA7.checked = getMostrarMA7();
      chkMA7.onchange = () => {
        setMostrarMA7(chkMA7.checked);
        desenharGrafico(atual);
      };
    }

    // Filtro: √∫ltimos X dias
    const chkUlt = document.getElementById('chkUltimosDias');
    const selUlt = document.getElementById('selUltimosDias');
    if (chkUlt && selUlt) {
      chkUlt.checked = getFiltroDiasAtivo();
      selUlt.value = String(getFiltroDiasValor());
      selUlt.disabled = !chkUlt.checked;

      chkUlt.onchange = () => {
        setFiltroDiasAtivo(chkUlt.checked);
        selUlt.disabled = !chkUlt.checked;
        desenharGrafico(atual);
      };
      selUlt.onchange = () => {
        setFiltroDiasValor(parseInt(selUlt.value, 10));
        desenharGrafico(atual);
      };
    }
    const chkIdeal = document.getElementById('chkIdeal');
    if (chkIdeal) {
      chkIdeal.checked = getMostrarIdeal();
      chkIdeal.onchange = () => { setMostrarIdeal(chkIdeal.checked); desenharGrafico(atual); };
    }

    desenharGrafico(atual);
  } else {
    renderCalendario(atual);
  }

  document.getElementById("historicoModal").style.display = "block";
}


function excluirRegistro(nome, indice) {
  if (!confirm("Deseja realmente excluir este registro?")) return;

  const hist = JSON.parse(localStorage.getItem(nome) || "[]");
  hist.splice(indice, 1);
  localStorage.setItem(nome, JSON.stringify(hist));

  abrir(nome);   // reabre o modal do item
  carregar();   // atualiza os cards
}



function fecharHistorico(){
  document.getElementById("historicoModal").style.display="none";
}

function editarMedicao(id) {
  const hist = JSON.parse(localStorage.getItem(atual) || "[]");
  const registro = hist.find(r => r.id === id);
  if (!registro) return;

  indiceEdicao = id;

  document.getElementById("data").value = registro.data;
  document.getElementById("valor").value = registro.valor;
  document.getElementById("obs").value = registro.obs || "";

  document.getElementById("modal").style.display = "flex";
}



function fecharTodosModais(){
  document.getElementById("modal").style.display = "none";
  document.getElementById("configModal").style.display = "none";
  document.getElementById("historicoModal").style.display = "none";
  const am = document.getElementById("analyticsModal");
  if (am) am.style.display = "none";
}


// ------------------- CONFIG -------------------
function abrirConfig(){
  fecharTodosModais();
  const cfg = carregarConfig();
  const div = document.getElementById("configCampos");
  div.innerHTML = "";

  // Usa a configura√ß√£o din√¢mica de cards para exibir o NOME amig√°vel (label),
  // mas mant√©m a chave interna (key) nos ids dos inputs para n√£o perder hist√≥rico.
  const cardsCfg = loadCardsConfig().slice().sort((a,b)=>(+a.ordem||999)-(+b.ordem||999));
  cardsCfg.forEach(c => {
    const key = c.key;
    const label = (c.label || key);
    // garantir que existe no objeto cfg
    if (!cfg[key]) cfg[key] = { dias: null, ideal: null };

    div.innerHTML += `
      <div class="config-item">
        <label>${escapeHtml(label)} ‚Äì Intervalo (dias)</label>
        <input type="number" id="dias_${escapeHtml(key)}" value="${cfg[key].dias ?? ""}">
        <label>${escapeHtml(label)} ‚Äì Valor ideal</label>
        <input type="number" step="any" id="ideal_${escapeHtml(key)}" value="${cfg[key].ideal ?? ""}">
      </div>
    `;
  });

  document.getElementById("configModal").style.display = "flex";
}

function fecharConfig(){
  document.getElementById("configModal").style.display="none";
}

function obterUltimaData(historico) {
  if (!historico.length) return null;

  let maisRecente = historico[0];

  historico.forEach(item => {
    if (new Date(item.data) > new Date(maisRecente.data)) {
      maisRecente = item;
    }
  });

  return maisRecente.data;
}

function salvarConfig(){
  const cfg = {};
  const cardsCfg = loadCardsConfig();
  cardsCfg.forEach(c => {
    const key = c.key;
    const diasEl = document.getElementById("dias_" + key);
    const idealEl = document.getElementById("ideal_" + key);

    const diasVal = diasEl ? diasEl.value : "";
    const idealVal = idealEl ? idealEl.value : "";

    cfg[key] = {
      dias: diasVal === "" ? null : parseInt(diasVal, 10),
      ideal: idealVal === "" ? null : parseFloat(idealVal)
    };
  });

  localStorage.setItem("config", JSON.stringify(cfg));
  fecharConfig();
  carregar();
}

function fecharConfirm() {
  document.getElementById("confirmModal").style.display = "none";
}



function pedirExclusao(item, id) {
  excluirItem = item;
  excluirId = id;
  document.getElementById("confirmModal").style.display = "flex";
}

function confirmarExclusao() {
  let hist = JSON.parse(localStorage.getItem(excluirItem) || "[]");

  hist = hist.filter(r => r.id !== excluirId);

  localStorage.setItem(excluirItem, JSON.stringify(hist));
  normalizarHistorico(excluirItem);

  fecharConfirm();
  abrirHistorico();
  carregar();
}



function exportarDados() {
  const backup = {
    versao: 2,
    dataExportacao: new Date().toISOString(),
    configuracoes: JSON.parse(localStorage.getItem("config") || "{}"),
    dados: {}
  };

  itens.forEach(nome => {
    const hist = JSON.parse(localStorage.getItem(nome) || "[]");

    backup.dados[nome] = hist.map(r => ({
      id: r.id || crypto.randomUUID(),
      data: r.data,
      valor: r.valor,
      obs: r.obs || ""
    }));
  });

  const blob = new Blob(
    [JSON.stringify(backup, null, 2)],
    { type: "application/json" }
  );

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "backup_aquario.json";
  a.click();
}



function importarDados(file) {

  if (!file) {
    alert("Nenhum arquivo selecionado.");
    return;
  }

  const reader = new FileReader();

  reader.onload = e => {
    try {
      const backup = JSON.parse(e.target.result);

      if (!backup || !backup.dados) {
        alert("Arquivo de backup inv√°lido.");
        return;
      }

      /* =========================
         CONFIGURA√á√ïES
      ========================= */
      if (backup.configuracoes) {
        localStorage.setItem(
          "config",
          JSON.stringify(backup.configuracoes)
        );
      }

      /* =========================
         DADOS
      ========================= */
      Object.keys(backup.dados).forEach(nome => {

        let hist = Array.isArray(backup.dados[nome])
          ? backup.dados[nome]
          : [];

        hist = hist.map(r => ({
          id: r.id || crypto.randomUUID(),
          data: r.data,
          valor: r.valor,
          obs: r.obs || ""
        }));

        // ordena sempre
        hist.sort((a, b) => new Date(a.data) - new Date(b.data));

        localStorage.setItem(nome, JSON.stringify(hist));
      });

      alert("Backup importado com sucesso!");

      fecharTodosModais();
      carregar();

    } catch (err) {
      console.error(err);
      alert("Erro ao importar o backup. Arquivo inv√°lido.");
    }
  };

  reader.onerror = () => {
    alert("Erro ao ler o arquivo.");
  };

  reader.readAsText(file);
}


let graficoAtual = null;
// ------------------- MARCA√á√ÉO DE TPA NO GR√ÅFICO -------------------
// L√™ o hist√≥rico de "TPA" e devolve timestamps (ms) normalizados para 00:00 do dia.
function obterTpaTimestamps() {
  const histTpa = JSON.parse(localStorage.getItem("TPA") || "[]");
  if (!Array.isArray(histTpa) || histTpa.length === 0) return [];

  // normaliza para YYYY-MM-DD e depois para timestamp do in√≠cio do dia (local)
  const diasUnicos = new Set(
    histTpa
      .map(r => (r?.data || "").slice(0, 10))
      .filter(Boolean)
  );

  const ts = [];
  diasUnicos.forEach(dia => {
    const d = new Date(dia + "T00:00:00");
    const t = d.getTime();
    if (Number.isFinite(t)) ts.push(t);
  });

  ts.sort((a, b) => a - b);
  return ts;
}

function montarLinhasEventos(item, pontos){
  const eventos = eventosDoGrafico(item);
  if (!eventos.length) return [];

  // limita marca√ß√µes ao intervalo exibido no gr√°fico para performance
  const minX = pontos[0]?.x ?? -Infinity;
  const maxX = pontos[pontos.length-1]?.x ?? Infinity;

  const estilos = {
    TPA:       { dash:[6,6],  color:"rgba(255,255,255,0.45)", lineWidth:2 },
    Carbonate: { dash:[2,6],  color:"rgba(79,195,247,0.55)",  lineWidth:2 },
    Phosgard:  { dash:[10,4], color:"rgba(255,193,7,0.45)",   lineWidth:2 },
    Perlon:    { dash:[1,5],  color:"rgba(200,200,200,0.35)", lineWidth:2 },
    Bacterias: { dash:[4,2],  color:"rgba(46,204,113,0.45)",  lineWidth:2 }
  };

  const linhas = [];
  for (const ev of eventos){
    if (!getEventoAtivo(item, ev)) continue;
    const xsAll = obterTimestampsEvento(ev);
    const xs = xsAll.filter(t => t >= minX && t <= maxX);
    if (!xs.length) continue;
    linhas.push({ xs, ...(estilos[ev] || {}) });
  }
  return linhas;
}



// Plugin simples para desenhar linhas verticais nas datas de TPA
const eventLinesPlugin = { id: "eventLines",
  afterDraw(chart, args, opts) {
    const lines = opts?.lines || [];
    if (!lines.length) return;

    const { ctx, chartArea, scales } = chart;
    const x = scales.x;
    if (!x) return;

    ctx.save();
    for (const ln of lines) {
      const xs = ln?.xs || [];
      if (!xs.length) continue;

      ctx.beginPath();
      ctx.lineWidth = ln.lineWidth ?? 2;
      ctx.setLineDash(ln.dash ?? [6, 6]);
      ctx.strokeStyle = ln.color ?? "rgba(255,255,255,0.40)";

      for (const t of xs) {
        const px = x.getPixelForValue(t);
        if (!Number.isFinite(px)) continue;
        ctx.moveTo(px, chartArea.top);
        ctx.lineTo(px, chartArea.bottom);
      }
      ctx.stroke();
    }
    ctx.restore();
  }
};

// Estado do checkbox (persistido)
function getMostrarTPA() {
  return localStorage.getItem("mostrarTPA") === "1";
}
function setMostrarTPA(v) {
  localStorage.setItem("mostrarTPA", v ? "1" : "0");
}


// Estado dos toggles do gr√°fico (persistidos)
function getMostrarMA7(){ return localStorage.getItem("mostrarMA7")==="1"; }
function setMostrarMA7(v){ localStorage.setItem("mostrarMA7", v ? "1":"0"); }
function getMostrarIdeal(){ return localStorage.getItem("mostrarIdeal")==="1"; }
function setMostrarIdeal(v){ localStorage.setItem("mostrarIdeal", v ? "1":"0"); }


// Filtro "√∫ltimos X dias" (persistido)
function getFiltroDiasAtivo() {
  return localStorage.getItem("filtroDiasAtivo") === "1";
}
function setFiltroDiasAtivo(v) {
  localStorage.setItem("filtroDiasAtivo", v ? "1" : "0");
}
function getFiltroDiasValor() {
  const raw = localStorage.getItem("filtroDiasValor") || "30";
  const n = parseInt(raw, 10);
  return [7, 30, 60, 90].includes(n) ? n : 30;
}
function setFiltroDiasValor(v) {
  const n = parseInt(String(v), 10);
  localStorage.setItem("filtroDiasValor", [7, 30, 60, 90].includes(n) ? String(n) : "30");
}


// Util num√©rica
function isNumero(v){ return typeof v === "number" && Number.isFinite(v); }
function round(v, casas=2){
  if(!isNumero(v)) return "‚Äî";
  const f = Math.pow(10, casas);
  return (Math.round(v*f)/f).toString().replace(".", ",");
}

// KPIs para o hist√≥rico (√∫ltimos N dias)
function filtrarPorDias(pontos, dias){
  const agora = Date.now();
  const lim = agora - dias*24*60*60*1000;
  return pontos.filter(p => p.x >= lim);
}

function statsBasicos(pontos){
  if(!pontos.length) return null;
  const ys = pontos.map(p=>p.y).filter(isNumero);
  if(!ys.length) return null;
  const min = Math.min(...ys);
  const max = Math.max(...ys);
  const avg = ys.reduce((a,b)=>a+b,0)/ys.length;
  const last = pontos[pontos.length-1].y;
  return {min,max,avg,last};
}

// Tend√™ncia via regress√£o linear simples (slope em "unidades por dia")
function slopePorDia(pontos){
  if(pontos.length < 2) return null;
  const xs = pontos.map(p=>p.x);
  const ys = pontos.map(p=>p.y);
  const n = pontos.length;
  const meanX = xs.reduce((a,b)=>a+b,0)/n;
  const meanY = ys.reduce((a,b)=>a+b,0)/n;
  let num = 0, den = 0;
  for(let i=0;i<n;i++){
    const dx = xs[i]-meanX;
    num += dx*(ys[i]-meanY);
    den += dx*dx;
  }
  if(den === 0) return null;
  const slopePerMs = num/den;
  return slopePerMs * 24*60*60*1000; // por dia
}

// M√©dia m√≥vel por janela em dias (time-based)
function mediaMovelPorDias(pontos, dias){
  const janelaMs = dias*24*60*60*1000;
  const out = [];
  let i0 = 0;
  let soma = 0;
  let count = 0;
  // Usamos uma fila simples
  const fila = [];
  for(const p of pontos){
    const x = p.x, y = p.y;
    // expira
    while(fila.length && (x - fila[0].x) > janelaMs){
      const r = fila.shift();
      soma -= r.y;
      count -= 1;
    }
    fila.push({x,y});
    soma += y;
    count += 1;
    out.push({x, y: count ? soma/count : null});
  }
  return out;
}

// Efeito m√©dio p√≥s-TPA: encontra medi√ß√£o mais pr√≥xima antes/depois (at√© 2 dias)
function efeitoPosTPA(pontos, tpaTs){
  if(!pontos.length || !tpaTs.length) return null;
  const maxDist = 2*24*60*60*1000;
  const deltas = [];
  for(const t of tpaTs){
    // antes
    let antes = null;
    for(let i=pontos.length-1;i>=0;i--){
      if(pontos[i].x <= t && (t - pontos[i].x) <= maxDist){ antes = pontos[i]; break; }
      if(pontos[i].x < t - maxDist) break;
    }
    // depois
    let depois = null;
    for(let i=0;i<pontos.length;i++){
      if(pontos[i].x >= t && (pontos[i].x - t) <= maxDist){ depois = pontos[i]; break; }
      if(pontos[i].x > t + maxDist) break;
    }
    if(antes && depois && isNumero(antes.y) && isNumero(depois.y)){
      deltas.push(depois.y - antes.y);
    }
  }
  if(!deltas.length) return null;
  return deltas.reduce((a,b)=>a+b,0)/deltas.length;
}

function atualizarKpisHistorico(item, pontos){
  const div = document.getElementById("histKpi");
  if(!div) return;

  const p30 = filtrarPorDias(pontos, 30);
  const st = statsBasicos(p30);
  const sl = slopePorDia(p30);
  const cfg = carregarConfig();
  const ideal = cfg?.[item]?.ideal;
  const eff = efeitoPosTPA(pontos, obterTpaTimestamps());

  const tendencia = (sl===null) ? "‚Äî" : (sl>0 ? `‚ñ≤ ${round(sl,3)}/dia` : `‚ñº ${round(Math.abs(sl),3)}/dia`);
  const desvioIdeal = (isNumero(ideal) && st && isNumero(st.last)) ? (st.last - ideal) : null;

  div.innerHTML = `
    <div class="kpi"><div class="kpi-label">√öltimo</div><div class="kpi-value">${st?round(st.last):"‚Äî"}</div></div>
    <div class="kpi"><div class="kpi-label">M√©dia 30d</div><div class="kpi-value">${st?round(st.avg):"‚Äî"}</div></div>
    <div class="kpi"><div class="kpi-label">Min/Max 30d</div><div class="kpi-value">${st?`${round(st.min)} / ${round(st.max)}`:"‚Äî"}</div></div>
    <div class="kpi"><div class="kpi-label">Tend√™ncia 30d</div><div class="kpi-value">${tendencia}</div></div>
    <div class="kpi"><div class="kpi-label">P√≥s-TPA (m√©dio)</div><div class="kpi-value">${eff===null?"‚Äî":(eff>0?`+${round(eff)}`:round(eff))}</div></div>
    <div class="kpi"><div class="kpi-label">Desvio do ideal</div><div class="kpi-value">${desvioIdeal===null?"‚Äî":(desvioIdeal>0?`+${round(desvioIdeal)}`:round(desvioIdeal))}</div></div>
  `;
}

// ------------------- MODAL ANALYTICS -------------------
function abrirAnalytics(){
  fecharTodosModais();
  document.getElementById("analyticsModal").style.display="flex";
  renderAnalytics();
}

function fecharAnalytics(){
  document.getElementById("analyticsModal").style.display="none";
}

function ultimaTPAData(){
  const hist = JSON.parse(localStorage.getItem("TPA")||"[]");
  if(!hist.length) return null;
  let max = hist[0].data;
  for(const r of hist){
    if(new Date(r.data) > new Date(max)) max = r.data;
  }
  return max;
}

function mediaIntervaloTPA(){
  const ts = obterTpaTimestamps();
  if(ts.length < 2) return null;
  let soma = 0;
  for(let i=1;i<ts.length;i++){
    soma += (ts[i]-ts[i-1]);
  }
  const mediaMs = soma/(ts.length-1);
  return mediaMs/(24*60*60*1000);
}

function renderAnalytics(){
  const cards = document.getElementById("analyticsCards");
  const pend = document.getElementById("analyticsPendencias");
  const desv = document.getElementById("analyticsDesvios");
  if(!cards || !pend || !desv) return;

  const cfg = carregarConfig();

  // Cards topo: TPA
  const uTPA = ultimaTPAData();
  const mTPA = mediaIntervaloTPA();

  cards.innerHTML = `
    <div class="analytics-card">
      <h4>üíß TPAs</h4>
      <div><span class="badge">√öltima</span> ${uTPA ? new Date(uTPA).toLocaleDateString("pt-BR") : "‚Äî"}</div>
      <div style="margin-top:6px;"><span class="badge">Intervalo m√©dio</span> ${mTPA===null ? "‚Äî" : `${round(mTPA,1)} dias`}</div>
    </div>
    <div class="analytics-card">
      <h4>üóÇÔ∏è Base de dados</h4>
      <div><span class="badge">Itens</span> ${itens.length}</div>
      <div style="margin-top:6px;"><span class="badge">Registros</span> ${itens.reduce((a,n)=>a + (JSON.parse(localStorage.getItem(n)||"[]").length),0)}</div>
    </div>
  `;

  // Pend√™ncias por intervalo (top 6)
  const pendencias = [];
  itens.forEach(nome=>{
    const hist = JSON.parse(localStorage.getItem(nome)||"[]");
    const ultima = obterUltimaData(hist);
    const diasStr = diasDesde(ultima);
    const limite = cfg?.[nome]?.dias;
    if(!limite || limite===null || isNaN(limite)) return;
    const dias = (diasStr==="Hoje") ? 0 : (diasStr==="1 dia") ? 1 : (diasStr==="Nunca") ? null : parseInt(diasStr);
    if(dias===null || isNaN(dias)) return;
    const atraso = dias - limite;
    pendencias.push({nome, dias, limite, atraso});
  });

  pendencias.sort((a,b)=> b.atraso - a.atraso);
  const topPend = pendencias.slice(0, 6);

  pend.innerHTML = `
    <table class="analytics-table">
      <thead><tr><th>Item</th><th>√öltima</th><th>Ideal</th><th>Status</th></tr></thead>
      <tbody>
        ${topPend.map(p=>{
          const st = p.atraso <= 0 ? "ok" : (p.atraso <= p.limite*0.2 ? "warn" : "danger");
          const badge = st==="ok" ? '<span class="badge">OK</span>' : st==="warn" ? '<span class="badge warn">Aten√ß√£o</span>' : '<span class="badge danger">Atrasado</span>';
          return `<tr><td>${p.nome}</td><td>${p.dias}d</td><td>${p.limite}d</td><td>${badge}</td></tr>`;
        }).join("")}
      </tbody>
    </table>
  `;

  // Desvio do ideal (top 6)
  const desvios = [];
  itens.forEach(nome=>{
    const ideal = cfg?.[nome]?.ideal;
    if(!isNumero(ideal)) return;
    const hist = JSON.parse(localStorage.getItem(nome)||"[]");
    if(!hist.length) return;
    hist.sort((a,b)=> new Date(a.data)-new Date(b.data));
    const last = Number(hist[hist.length-1].valor);
    if(!isNumero(last)) return;
    desvios.push({nome, last, ideal, diff: last-ideal, abs: Math.abs(last-ideal)});
  });
  desvios.sort((a,b)=> b.abs - a.abs);
  const topDesv = desvios.slice(0, 6);

  desv.innerHTML = topDesv.length ? `
    <table class="analytics-table">
      <thead><tr><th>Item</th><th>√öltimo</th><th>Ideal</th><th>Œî</th></tr></thead>
      <tbody>
        ${topDesv.map(d=>{
          const delta = d.diff;
          const txt = delta>0 ? `+${round(delta)}` : round(delta);
          return `<tr><td>${d.nome}</td><td>${round(d.last)}</td><td>${round(d.ideal)}</td><td>${txt}</td></tr>`;
        }).join("")}
      </tbody>
    </table>
  ` : "<div>Defina valores ideais nas Configura√ß√µes para ver este ranking.</div>";
}


function prepararDadosGrafico(item) {
  const hist = JSON.parse(localStorage.getItem(item) || "[]");
  if (hist.length === 0) return [];

  hist.sort((a, b) => new Date(a.data) - new Date(b.data));

  return hist.map(r => ({
    x: new Date(r.data).getTime(), // üëà timestamp (n√∫mero)
    y: Number(r.valor)
  }));
}







function desenharGrafico(item) {
  const canvas = document.getElementById("grafico");
  if (!canvas) return;

  let pontos = prepararDadosGrafico(item);
  if (pontos.length === 0) return;

  // Filtro: √∫ltimos X dias
  if (getFiltroDiasAtivo()) {
    const dias = getFiltroDiasValor();
    const corte = Date.now() - dias * 24 * 60 * 60 * 1000;
    const filtrado = pontos.filter(p => p.x >= corte);
    pontos = (filtrado.length > 0) ? filtrado : [pontos[pontos.length - 1]];
  }

  // KPIs
  atualizarKpisHistorico(item, pontos);

  if (graficoAtual) graficoAtual.destroy();

  const datasets = [{
    label: item,
    data: pontos,
    parsing: false,
    borderColor: "#4fc3f7",
    backgroundColor: "rgba(79,195,247,0.2)",
    tension: 0.3,
    pointRadius: 4
  }];

  // M√©dia m√≥vel 7 dias
  if (getMostrarMA7()) {
    const ma = mediaMovelPorDias(pontos, 7);
    datasets.push({
      label: "M√©dia 7 dias",
      data: ma,
      parsing: false,
      borderColor: "rgba(255,255,255,0.65)",
      backgroundColor: "rgba(255,255,255,0.08)",
      tension: 0.25,
      pointRadius: 0,
      borderWidth: 2
    });
  }

  // Linha ideal (se configurada)
  if (getMostrarIdeal()) {
    const cfg = carregarConfig();
    const ideal = cfg?.[item]?.ideal;
    if (typeof ideal === "number" && Number.isFinite(ideal)) {
      const minX = pontos[0].x;
      const maxX = pontos[pontos.length - 1].x;
      datasets.push({
        label: "Ideal",
        data: [{x:minX, y: ideal},{x:maxX, y: ideal}],
        parsing: false,
        borderColor: "rgba(46, 204, 113, 0.85)",
        borderWidth: 2,
        pointRadius: 0,
        tension: 0
      });
    }
  }

  graficoAtual = new Chart(canvas.getContext("2d"), {
    type: "line",
    plugins: [eventLinesPlugin],
    data: { datasets },
    options: {
      responsive: true,
      plugins: {
        eventLines: {
          lines: montarLinhasEventos(item, pontos)
        },
        legend: { display: true }
      },
      scales: {
        x: {
          type: "linear",
          title: { display: true, text: "Data" },
          ticks: {
            callback: value => new Date(value).toLocaleDateString("pt-BR")
          }
        },
        y: {
          title: { display: true, text: "Valor" }
        }
      }
    }
  });
}

function normalizarHistorico(nome) {
  const hist = JSON.parse(localStorage.getItem(nome) || "[]");

  hist.sort((a, b) => new Date(a.data) - new Date(b.data));

  localStorage.setItem(nome, JSON.stringify(hist));
  return hist;
}



// ------------------- CALEND√ÅRIO (itens sem gr√°fico) -------------------
let _calYear = null;
let _calMonth = null; // 0-11

function getMonthNamePt(m){
  const nomes = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  return nomes[m] || "";
}

function _extrairDatasMarcadas(item){
  const hist = JSON.parse(localStorage.getItem(item) || "[]");
  // mapa YYYY-MM-DD -> contagem (normalmente 1; mantido por compatibilidade)
  const mapa = {};
  for (const r of hist){
    if (!r?.data) continue;
    const d = String(r.data).slice(0,10);
    mapa[d] = (mapa[d] || 0) + 1;
  }
  return mapa;
}

// Para itens sem gr√°fico: mostra "dias desde a interven√ß√£o anterior" no calend√°rio.
// Retorna { badges: {YYYY-MM-DD: {text, cls}}, totalDiasMarcados, idealDias }
function _extrairBadgesCalendario(item){
  const hist = JSON.parse(localStorage.getItem(item) || "[]");
  const datas = [];
  for (const r of hist){
    if (!r?.data) continue;
    datas.push(String(r.data).slice(0,10));
  }
  // √∫nicos + ordenados
  const uniq = Array.from(new Set(datas)).sort(); // YYYY-MM-DD ordena lexicograficamente
  const cfg = carregarConfig();
  const ideal = Number(cfg?.[item]?.dias || 0);

  function diffDays(a, b){
    const da = new Date(a + "T00:00:00");
    const db = new Date(b + "T00:00:00");
    return Math.round((db - da) / 86400000);
  }

  function classificar(delta){
    if (!ideal || ideal <= 0 || delta == null) return "";
    if (delta === ideal) return "good";      // no prazo
    if (delta < ideal) return "early";       // antes do prazo
    // depois do prazo
    if (delta <= ideal + 2) return "late";   // pouco atrasado
    return "verylate";                       // bem atrasado
  }

  const badges = {};
  let prev = null;
  for (const d of uniq){
    if (!prev){
      badges[d] = { text: "‚Ä¢", cls: "first" }; // primeiro registro (sem intervalo anterior)
      prev = d;
      continue;
    }
    const delta = diffDays(prev, d);
    badges[d] = { text: String(delta), cls: classificar(delta) };
    prev = d;
  }

  return { badges, totalDiasMarcados: uniq.length, idealDias: ideal };
}

function renderCalendario(item){
  const pnl = document.getElementById("tab-calendario");
  if (!pnl || pnl.style.display === "none") return;

  const grid = document.getElementById("calGrid");
  const title = document.getElementById("calTitle");
  const legend = document.getElementById("calLegend");
  if (!grid || !title) return;

  const infoCal = _extrairBadgesCalendario(item);

  const badges = infoCal.badges || {};

  // init m√™s/ano se necess√°rio
  const hoje = new Date();
  if (_calYear === null || _calMonth === null){
    _calYear = hoje.getFullYear();
    _calMonth = hoje.getMonth();
  }

  // Cabe√ßalho
  title.textContent = `${getMonthNamePt(_calMonth)} ${_calYear}`;

  // Monta grid
  grid.innerHTML = "";

  const dows = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
  for (const d of dows){
    const el = document.createElement("div");
    el.className = "cal-dow";
    el.textContent = d;
    grid.appendChild(el);
  }

  const first = new Date(_calYear, _calMonth, 1);
  const last  = new Date(_calYear, _calMonth + 1, 0);
  const startDow = first.getDay(); // 0 dom
  const daysInMonth = last.getDate();

  // dias do m√™s anterior (para completar semana)
  const prevLast = new Date(_calYear, _calMonth, 0).getDate();
  for (let i=0;i<startDow;i++){
    const dayNum = prevLast - startDow + 1 + i;
    const cell = document.createElement("div");
    cell.className = "cal-cell muted";
    cell.innerHTML = `<div class="cal-day">${dayNum}</div>`;
    grid.appendChild(cell);
  }

  // dias do m√™s atual
  for (let day=1; day<=daysInMonth; day++){
    const cell = document.createElement("div");
    cell.className = "cal-cell";
    const dateKey = `${_calYear}-${String(_calMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const badge = badges[dateKey];

    cell.innerHTML = `<div class="cal-day">${day}</div>` + (badge ? `<div class="cal-mark ${badge.cls||""}">${badge.text}</div>` : "");
    grid.appendChild(cell);
  }

  // completar com pr√≥ximos dias at√© fechar a grade (m√∫ltiplo de 7 ap√≥s o cabe√ßalho)
  const totalCells = 7 + startDow + daysInMonth; // 7 dow headers
  const remainder = totalCells % 7;
  const fill = remainder === 0 ? 0 : 7 - remainder;
  for (let i=1;i<=fill;i++){
    const cell = document.createElement("div");
    cell.className = "cal-cell muted";
    cell.innerHTML = `<div class="cal-day">${i}</div>`;
    grid.appendChild(cell);
  }

  const totalMarcados = infoCal.totalDiasMarcados || 0;
  if (legend) {
    if (!totalMarcados) {
      legend.textContent = "Nenhum registro encontrado para este item.";
    } else {
      const idealTxt = infoCal.idealDias ? ` | Intervalo ideal: ${infoCal.idealDias} dia(s)` : "";
      legend.textContent = `Dias com registros: ${totalMarcados}. O n√∫mero no canto indica quantos dias se passaram desde a interven√ß√£o anterior.${idealTxt}`;
    }
  }

  // listeners de navega√ß√£o (idempotente)
  const prevBtn = document.getElementById("calPrev");
  const nextBtn = document.getElementById("calNext");
  const hojeBtn = document.getElementById("calHoje");

  if (prevBtn && !prevBtn._bound){
    prevBtn._bound = true;
    prevBtn.addEventListener("click", () => {
      _calMonth -= 1;
      if (_calMonth < 0){ _calMonth = 11; _calYear -= 1; }
      renderCalendario(item);
    });
  }
  if (nextBtn && !nextBtn._bound){
    nextBtn._bound = true;
    nextBtn.addEventListener("click", () => {
      _calMonth += 1;
      if (_calMonth > 11){ _calMonth = 0; _calYear += 1; }
      renderCalendario(item);
    });
  }
  if (hojeBtn && !hojeBtn._bound){
    hojeBtn._bound = true;
    hojeBtn.addEventListener("click", () => {
      const h = new Date();
      _calYear = h.getFullYear();
      _calMonth = h.getMonth();
      renderCalendario(item);
    });
  }
}

// Tabs do Hist√≥rico (delega√ß√£o de evento)
document.addEventListener("click", (e) => {
  const btn = e.target.closest("#historicoModal .tab-btn");
  if (!btn) return;
  setTabHistorico(btn.dataset.tab);
});

// ------------------- INIT -------------------
carregar();


if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker registrado"))
    .catch(err => console.error("SW erro", err));
}



</script>





</body>
</html>

